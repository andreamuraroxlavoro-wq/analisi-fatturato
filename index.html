<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Analisi Fatturato PRO">
<meta name="theme-color" content="#0d0f14">
<title>Analisi Fatturato PRO</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkFuYWxpc2kgRmF0dHVyYXRvIFBSTyIsICJzaG9ydF9uYW1lIjogIkZhdHR1cmF0byIsICJkZXNjcmlwdGlvbiI6ICJEYXNoYm9hcmQgY29tbWVyY2lhbGUgcGVyIGFuYWxpc2kgZmF0dHVyYXRvIiwgInN0YXJ0X3VybCI6ICIuIiwgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZDBmMTQiLCAidGhlbWVfY29sb3IiOiAiIzBkMGYxNCIsICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwgImljb25zIjogW3sic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJMU1USWlJR2hsYVdkb2REMGlOVEV5SWlCMmFXVjNRbTk0UFNJd0lEQWdOVEV5SURVeE1pSStDaUFnUEdSbFpuTStDaUFnSUNBOGJHbHVaV0Z5UjNKaFpHbGxiblFnYVdROUltSm5JaUI0TVQwaU1DVWlJSGt4UFNJd0pTSWdlREk5SWpFd01DVWlJSGt5UFNJeE1EQWxJajRLSUNBZ0lDQWdQSE4wYjNBZ2IyWm1jMlYwUFNJd0pTSWdjM1I1YkdVOUluTjBiM0F0WTI5c2IzSTZJMlV5WWpnMFlTSXZQZ29nSUNBZ0lDQThjM1J2Y0NCdlptWnpaWFE5SWpVMUpTSWdjM1I1YkdVOUluTjBiM0F0WTI5c2IzSTZJMk01T0RVellTSXZQZ29nSUNBZ0lDQThjM1J2Y0NCdlptWnpaWFE5SWpFd01DVWlJSE4wZVd4bFBTSnpkRzl3TFdOdmJHOXlPaU5oTURWak1qQWlMejRLSUNBZ0lEd3ZiR2x1WldGeVIzSmhaR2xsYm5RK0NpQWdQQzlrWldaelBnb2dJRHh5WldOMElIZHBaSFJvUFNJMU1USWlJR2hsYVdkb2REMGlOVEV5SWlCeWVEMGlNVEUxSWlCbWFXeHNQU0oxY213b0kySm5LU0l2UGdvZ0lEeHlaV04wSUhnOUlqZ3dJaUI1UFNJNE1DSWdkMmxrZEdnOUlqTTFNaUlnYUdWcFoyaDBQU0k1TUNJZ2NuZzlJakU0SWlCbWFXeHNQU0p5WjJKaEtESTFOU3d5TlRVc01qVTFMREF1T1RJcElpOCtDaUFnUEhKbFkzUWdlRDBpT0RBaUlIazlJakl3TUNJZ2QybGtkR2c5SWpJek1DSWdhR1ZwWjJoMFBTSTNNQ0lnY25nOUlqRTBJaUJtYVd4c1BTSnlaMkpoS0RJMU5Td3lOVFVzTWpVMUxEQXVOelVwSWk4K0NpQWdQSEpsWTNRZ2VEMGlPREFpSUhrOUlqTXdNQ0lnZDJsa2RHZzlJakUxTlNJZ2FHVnBaMmgwUFNJM01DSWdjbmc5SWpFMElpQm1hV3hzUFNKeVoySmhLREkxTlN3eU5UVXNNalUxTERBdU5UVXBJaTgrQ2lBZ1BIQnZiSGxzYVc1bElIQnZhVzUwY3owaU16WXdMREkyTUNBME16QXNNelF3SURNMk1DdzBNakFpSUhOMGNtOXJaVDBpY21kaVlTZ3lOVFVzTWpVMUxESTFOU3d3TGprMUtTSWdjM1J5YjJ0bExYZHBaSFJvUFNJek5pSWdjM1J5YjJ0bExXeHBibVZqWVhBOUluSnZkVzVrSWlCemRISnZhMlV0YkdsdVpXcHZhVzQ5SW5KdmRXNWtJaUJtYVd4c1BTSnViMjVsSWk4K0NpQWdQR3hwYm1VZ2VERTlJalF6TUNJZ2VURTlJak0wTUNJZ2VESTlJak13TUNJZ2VUSTlJak0wTUNJZ2MzUnliMnRsUFNKeVoySmhLREkxTlN3eU5UVXNNalUxTERBdU9UVXBJaUJ6ZEhKdmEyVXRkMmxrZEdnOUlqTTJJaUJ6ZEhKdmEyVXRiR2x1WldOaGNEMGljbTkxYm1RaUx6NEtQQzl6ZG1jKyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSJ9XX0=">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2UyYjg0YSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3R5bGU9InN0b3AtY29sb3I6I2M5ODUzYSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNhMDVjMjAiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSJ1cmwoI2JnKSIvPgogIDxyZWN0IHg9IjgwIiB5PSI4MCIgd2lkdGg9IjM1MiIgaGVpZ2h0PSI5MCIgcng9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTIpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjIwMCIgd2lkdGg9IjIzMCIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNzUpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjMwMCIgd2lkdGg9IjE1NSIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNTUpIi8+CiAgPHBvbHlsaW5lIHBvaW50cz0iMzYwLDI2MCA0MzAsMzQwIDM2MCw0MjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjk1KSIgc3Ryb2tlLXdpZHRoPSIzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+CiAgPGxpbmUgeDE9IjQzMCIgeTE9IjM0MCIgeDI9IjMwMCIgeTI9IjM0MCIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpIiBzdHJva2Utd2lkdGg9IjM2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2UyYjg0YSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3R5bGU9InN0b3AtY29sb3I6I2M5ODUzYSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNhMDVjMjAiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSJ1cmwoI2JnKSIvPgogIDxyZWN0IHg9IjgwIiB5PSI4MCIgd2lkdGg9IjM1MiIgaGVpZ2h0PSI5MCIgcng9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTIpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjIwMCIgd2lkdGg9IjIzMCIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNzUpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjMwMCIgd2lkdGg9IjE1NSIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNTUpIi8+CiAgPHBvbHlsaW5lIHBvaW50cz0iMzYwLDI2MCA0MzAsMzQwIDM2MCw0MjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjk1KSIgc3Ryb2tlLXdpZHRoPSIzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+CiAgPGxpbmUgeDE9IjQzMCIgeTE9IjM0MCIgeDI9IjMwMCIgeTI9IjM0MCIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpIiBzdHJva2Utd2lkdGg9IjM2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
<link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2UyYjg0YSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3R5bGU9InN0b3AtY29sb3I6I2M5ODUzYSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNhMDVjMjAiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSJ1cmwoI2JnKSIvPgogIDxyZWN0IHg9IjgwIiB5PSI4MCIgd2lkdGg9IjM1MiIgaGVpZ2h0PSI5MCIgcng9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTIpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjIwMCIgd2lkdGg9IjIzMCIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNzUpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjMwMCIgd2lkdGg9IjE1NSIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNTUpIi8+CiAgPHBvbHlsaW5lIHBvaW50cz0iMzYwLDI2MCA0MzAsMzQwIDM2MCw0MjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjk1KSIgc3Ryb2tlLXdpZHRoPSIzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+CiAgPGxpbmUgeDE9IjQzMCIgeTE9IjM0MCIgeDI9IjMwMCIgeTI9IjM0MCIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpIiBzdHJva2Utd2lkdGg9IjM2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
<link rel="apple-touch-icon" sizes="167x167" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2UyYjg0YSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3R5bGU9InN0b3AtY29sb3I6I2M5ODUzYSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNhMDVjMjAiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSJ1cmwoI2JnKSIvPgogIDxyZWN0IHg9IjgwIiB5PSI4MCIgd2lkdGg9IjM1MiIgaGVpZ2h0PSI5MCIgcng9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTIpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjIwMCIgd2lkdGg9IjIzMCIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNzUpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjMwMCIgd2lkdGg9IjE1NSIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNTUpIi8+CiAgPHBvbHlsaW5lIHBvaW50cz0iMzYwLDI2MCA0MzAsMzQwIDM2MCw0MjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjk1KSIgc3Ryb2tlLXdpZHRoPSIzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+CiAgPGxpbmUgeDE9IjQzMCIgeTE9IjM0MCIgeDI9IjMwMCIgeTI9IjM0MCIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpIiBzdHJva2Utd2lkdGg9IjM2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2UyYjg0YSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3R5bGU9InN0b3AtY29sb3I6I2M5ODUzYSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNhMDVjMjAiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTE1IiBmaWxsPSJ1cmwoI2JnKSIvPgogIDxyZWN0IHg9IjgwIiB5PSI4MCIgd2lkdGg9IjM1MiIgaGVpZ2h0PSI5MCIgcng9IjE4IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTIpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjIwMCIgd2lkdGg9IjIzMCIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNzUpIi8+CiAgPHJlY3QgeD0iODAiIHk9IjMwMCIgd2lkdGg9IjE1NSIgaGVpZ2h0PSI3MCIgcng9IjE0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNTUpIi8+CiAgPHBvbHlsaW5lIHBvaW50cz0iMzYwLDI2MCA0MzAsMzQwIDM2MCw0MjAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjk1KSIgc3Ryb2tlLXdpZHRoPSIzNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+CiAgPGxpbmUgeDE9IjQzMCIgeTE9IjM0MCIgeDI9IjMwMCIgeTI9IjM0MCIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOTUpIiBzdHJva2Utd2lkdGg9IjM2IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161a22;
    --surface2: #1e2330;
    --gold: #c9a84c;
    --gold-light: #e8c96e;
    --text: #f0ede8;
    --text-muted: #7a8099;
    --green: #4caf82;
    --red: #e05c5c;
    --border: rgba(201,168,76,0.15);
    --radius: 16px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 15px;
  }

  /* APP LAYOUT */
  #app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

  /* HEADER */
  header {
    background: var(--surface);
    padding: 46px 20px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .app-logo-wrap {
    display: flex; align-items: center; gap: 14px;
    min-width: 0; flex-shrink: 1;
  }
  /* Responsive: su schermi molto stretti i pulsanti vanno sotto */
  @media (max-width: 480px) {
    .header-top {
      flex-direction: column;
      align-items: flex-start;
    }
    .header-actions {
      width: 100%;
      justify-content: stretch;
    }
    .header-actions .btn-session,
    .header-actions #import-btn {
      flex: 1;
      justify-content: center;
      font-size: 11px;
      padding: 9px 8px;
    }
  }
  .app-icon {
    width: 62px; height: 62px; border-radius: 16px; flex-shrink: 0;
    background: linear-gradient(145deg, #f0c456 0%, #d4902e 50%, #a05c18 100%);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 18px rgba(226,184,74,0.50), inset 0 1px 0 rgba(255,255,255,0.22);
    position: relative; overflow: hidden;
  }
  .app-icon::before {
    content: '';
    position: absolute; top: -8px; left: -8px;
    width: 30px; height: 30px;
    background: rgba(255,255,255,0.13);
    border-radius: 50%;
  }
  .app-title-block {
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .app-title {
    font-family: 'Nunito', sans-serif;
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -0.3px;
    line-height: 1.05;
    background: linear-gradient(90deg, #f5d080 0%, #e2b84a 50%, #ff9f2e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .app-title .title-pro {
    font-size: 15px;
    font-weight: 900;
    letter-spacing: 2.5px;
    background: linear-gradient(90deg, #ffffff 0%, #ddd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    vertical-align: middle;
    margin-left: 6px;
    text-transform: uppercase;
  }
  .header-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 1px; letter-spacing: 0.2px; }
  #header-version {
    display: inline-flex; align-items: center;
    font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.55);
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px;
    padding: 2px 10px;
    margin-top: 4px;
    width: fit-content;
    letter-spacing: 0.3px;
  }
  #import-btn {
    background: var(--gold);
    color: #0d0f14;
    border: none;
    border-radius: 12px;
    padding: 10px 16px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
  }
  #import-btn:active { background: var(--gold-light); }
  #file-input { display: none; }
  #session-input { display: none; }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  .btn-session {
    display: flex; align-items: center; gap: 5px;
    padding: 9px 13px;
    border-radius: 12px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.18s;
    -webkit-tap-highlight-color: transparent;
    white-space: nowrap;
  }
  .btn-save-session {
    background: rgba(76,175,130,0.15);
    border: 2px solid rgba(76,175,130,0.6);
    color: #4caf82;
  }
  .btn-save-session:active { background: rgba(76,175,130,0.28); }
  .btn-load-session {
    background: rgba(116,185,255,0.12);
    border: 2px solid rgba(116,185,255,0.5);
    color: #74b9ff;
  }
  .btn-load-session:active { background: rgba(116,185,255,0.25); }
  .btn-save-session.has-data {
    animation: pulse-save 2.5s ease-in-out infinite;
  }
  /* ‚îÄ‚îÄ IMPOSTAZIONI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .settings-section {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .settings-section-title {
    font-size: 11px; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1.6px; color: #f0d878;
    padding: 12px 18px 12px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(90deg, rgba(226,184,74,0.12) 0%, transparent 100%);
    border-left: 3px solid #e2b84a;
    text-shadow: 0 0 14px rgba(240,216,120,0.3);
  }
  .settings-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 18px; gap: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .settings-row:last-child { border-bottom: none; }
  .settings-row-info { flex: 1; min-width: 0; }
  .settings-row-label {
    font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 3px;
  }
  .settings-row-desc {
    font-size: 11px; color: var(--text-muted); line-height: 1.4;
  }
  .settings-input {
    width: 100%; padding: 11px 14px;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 10px; color: #fff;
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500;
    outline: none; transition: border-color 0.18s; box-sizing: border-box;
  }
  .settings-input:focus { border-color: var(--gold); }
  .settings-input-row {
    display: flex; gap: 8px; align-items: center; margin-top: 10px;
  }
  /* Toggle switch */
  .toggle-wrap { position: relative; width: 50px; height: 28px; flex-shrink: 0; }
  .toggle-wrap input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.12);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 30px; cursor: pointer; transition: all 0.22s;
  }
  .toggle-slider:before {
    content: ''; position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 50%; transform: translateY(-50%);
    background: rgba(255,255,255,0.5);
    border-radius: 50%; transition: all 0.22s;
  }
  .toggle-wrap input:checked + .toggle-slider {
    background: rgba(76,175,130,0.3);
    border-color: #4caf82;
  }
  .toggle-wrap input:checked + .toggle-slider:before {
    transform: translateX(22px) translateY(-50%);
    background: #4caf82;
  }
  .settings-save-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, rgba(226,184,74,0.2), rgba(226,184,74,0.08));
    border: 2px solid rgba(226,184,74,0.5);
    border-radius: 12px; color: var(--gold);
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all 0.18s; margin-top: 6px;
  }
  .settings-save-btn:active { background: rgba(226,184,74,0.25); transform: scale(0.98); }

  /* Modal avviso non salvato */
  .unsaved-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(6px);
    z-index: 9999;
    display: flex; align-items: flex-end; justify-content: center;
    padding: 0 0 env(safe-area-inset-bottom,0);
    animation: fadeInOverlay 0.2s ease;
  }
  @keyframes fadeInOverlay { from { opacity:0 } to { opacity:1 } }
  .unsaved-sheet {
    background: #1a1f2a;
    border: 2px solid rgba(255,146,43,0.55);
    border-radius: 20px 20px 0 0;
    padding: 28px 24px 36px;
    width: 100%;
    max-width: 480px;
    animation: slideUpSheet 0.25s cubic-bezier(.2,.9,.4,1);
  }
  @keyframes slideUpSheet { from { transform:translateY(100%) } to { transform:translateY(0) } }
  .unsaved-icon { font-size: 42px; text-align: center; margin-bottom: 14px; }
  .unsaved-title { font-size: 18px; font-weight: 800; color: #fff; text-align: center; margin-bottom: 8px; }
  .unsaved-sub { font-size: 13px; color: rgba(255,255,255,0.55); text-align: center; margin-bottom: 24px; line-height: 1.5; }
  .unsaved-actions { display: flex; flex-direction: column; gap: 10px; }
  .unsaved-btn {
    width: 100%; padding: 14px; border-radius: 14px;
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all 0.18s; border: 2px solid transparent;
    -webkit-tap-highlight-color: transparent;
  }
  .unsaved-btn-save {
    background: linear-gradient(135deg, #4caf82, #3a9e72);
    color: #fff; border-color: #4caf82;
    box-shadow: 0 4px 18px rgba(76,175,130,0.4);
  }
  .unsaved-btn-save:active { opacity: 0.85; transform: scale(0.98); }
  .unsaved-btn-discard {
    background: rgba(224,92,92,0.12);
    color: #e05c5c; border-color: rgba(224,92,92,0.45);
  }
  .unsaved-btn-discard:active { background: rgba(224,92,92,0.22); }
  .unsaved-btn-cancel {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.18);
  }
  .unsaved-btn-cancel:active { background: rgba(255,255,255,0.12); }

  @keyframes pulse-save {
    0%,100% { box-shadow: 0 0 0 0 rgba(76,175,130,0); }
    50%      { box-shadow: 0 0 0 5px rgba(76,175,130,0.18); }
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 4px;
    padding: 10px 12px 0;
    background: var(--surface);
    overflow-x: auto;
    scrollbar-width: none;
    flex-shrink: 0;
    border-bottom: 2px solid var(--border);
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 10px 14px 12px;
    border-radius: 12px 12px 0 0;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.38);
    cursor: pointer;
    white-space: nowrap;
    border: 1px solid transparent;
    border-bottom: none;
    transition: all 0.2s;
    background: transparent;
    -webkit-tap-highlight-color: transparent;
  }
  .tab .tab-icon {
    width: 28px; height: 28px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .tab.active {
    color: #fff;
    background: var(--bg);
    border-color: var(--border);
  }
  .tab.active .tab-icon {
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  .tab:not(.active):hover { color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.04); }

  /* CONTENT */
  #content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    -webkit-overflow-scrolling: touch;
  }

  /* CARDS */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 18px;
    margin-bottom: 16px;
  }
  .card-title {
    font-size: 12px;
    color: #e8c96a;
    text-transform: uppercase;
    letter-spacing: 1.6px;
    margin-bottom: 16px;
    font-weight: 800;
    padding: 8px 12px;
    background: linear-gradient(90deg, rgba(226,184,74,0.12) 0%, rgba(226,184,74,0.03) 100%);
    border-left: 3px solid #e2b84a;
    border-radius: 0 8px 8px 0;
    margin-left: -16px;
    margin-right: -16px;
  }

  /* KPI ROW */
  .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 0; }
  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .kpi-label { font-size: 11px; color: #d4a843; text-transform: uppercase; letter-spacing: 1.4px; font-weight: 800; margin-bottom: 2px; }
  .kpi-value { font-size: 22px; font-weight: 600; color: var(--gold); margin: 4px 0; line-height: 1; }
  .kpi-sub { font-size: 11px; color: var(--text-muted); }
  .kpi-card.full { grid-column: 1 / -1; }

  /* CHART */
  .chart-wrap { position: relative; height: 220px; }

  /* TABLE */
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { color: var(--text-muted); font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:last-child td { border-bottom: none; }
  tr:active td { background: var(--surface2); }
  .amount { font-weight: 600; color: var(--gold-light); }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    background: rgba(201,168,76,0.15);
    color: var(--gold);
  }

  /* FILTERS */
  .filter-row { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
  .filter-row::-webkit-scrollbar { display: none; }
  .filter-pill {
    flex-shrink: 0;
    padding: 9px 16px;
    border-radius: 20px;
    border: 2px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.2px;
  }
  .filter-pill.active {
    background: var(--gold);
    color: #0d0f14;
    border-color: var(--gold);
    font-weight: 700;
    box-shadow: 0 0 12px rgba(201,168,76,0.4);
  }
  select, input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 10px 14px;
    width: 100%;
    outline: none;
    -webkit-appearance: none;
  }
  .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
  .search-row input { flex: 1; }
  .search-row select { width: 140px; flex-shrink: 0; }

  /* EMPTY STATE */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-icon { font-size: 48px; margin-bottom: 16px; }
  .empty h3 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text); margin-bottom: 8px; }
  .empty p { font-size: 13px; line-height: 1.6; }

  /* IMPORT MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: flex-end;
    animation: fadeIn 0.2s;
  }
  @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
  .modal {
    background: var(--surface);
    border-radius: 24px 24px 0 0;
    padding: 24px 20px 40px;
    width: 100%;
    border-top: 1px solid var(--border);
    animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes slideUp { from { transform: translateY(100%) } to { transform: translateY(0) } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 20px; margin-bottom: 6px; }
  .modal-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
  .option-group { margin-bottom: 16px; }
  .option-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .options { display: flex; gap: 8px; }
  .opt-btn {
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
  }
  .opt-btn.selected { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.1); }
  .confirm-btn {
    width: 100%;
    padding: 16px;
    border-radius: 14px;
    border: none;
    background: var(--gold);
    color: #0d0f14;
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.2s;
  }
  .confirm-btn:active { background: var(--gold-light); }
  .cancel-btn {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    cursor: pointer;
    margin-top: 8px;
  }

  /* COLUMN MAPPING */
  .mapping-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .mapping-label { font-size: 13px; font-weight: 500; width: 100px; flex-shrink: 0; color: var(--gold); }
  .mapping-row select { flex: 1; }

  /* TOAST */
  .toast {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--green);
    color: white;
    padding: 12px 20px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 600;
    z-index: 200;
    animation: toastIn 0.3s, toastOut 0.3s 2.7s forwards;
    white-space: nowrap;
  }
  .toast.error { background: var(--red); }
  .toast.ok {
    background: linear-gradient(135deg,#0d4f2b,#1a6e3c);
    border: 2px solid #4cdf8a;
    font-weight: 700;
    font-size: 14px;
    padding: 16px 26px;
    max-width: 460px;
    white-space: normal;
    text-align: center;
    line-height: 1.5;
    box-shadow: 0 0 30px rgba(76,223,138,0.35);
  }
  @keyframes toastIn { from { opacity:0; top:40px } to { opacity:1; top:60px } }
  @keyframes toastOut { to { opacity:0; top:40px } }

  /* ‚îÄ‚îÄ Storage status bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #storage-status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
    padding: 5px 16px;
    background: rgba(0,0,0,0.3);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    min-height: 32px;
  }
  #storage-status-bar .ssb-label {
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.25);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-right: 4px;
    font-family: 'DM Sans', sans-serif;
  }
  .ssb-item {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 11px 3px 7px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.4s;
  }
  .ssb-item.active {
    color: #4cdf8a;
    background: rgba(76,223,138,0.10);
    border: 1.5px solid rgba(76,223,138,0.4);
  }
  .ssb-item.inactive {
    color: rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.03);
    border: 1.5px solid rgba(255,255,255,0.08);
  }
  .ssb-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .ssb-item.active  .ssb-dot { background:#4cdf8a; box-shadow:0 0 5px #4cdf8a; animation: pulse-dot 2s ease-in-out infinite; }
  .ssb-item.inactive .ssb-dot { background:#e05c5c; }
  .ssb-sep { color:rgba(255,255,255,0.1); font-size:10px; }

  /* DATASETS LIST */
  .dataset-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }
  .dataset-item:last-child { border-bottom: none; }
  .dataset-info {}
  .dataset-name { font-weight: 500; font-size: 14px; }
  .dataset-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .delete-btn {
    background: rgba(224,92,92,0.15);
    border: none;
    color: var(--red);
    width: 32px; height: 32px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* EXPORT */
  .export-btn {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    transition: border-color 0.2s;
  }
  .export-btn:active { border-color: var(--gold); }
  .btn-icon { font-size: 18px; }

  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .section-label {
    font-size: 13px; color: #f0d878; text-transform: uppercase;
    letter-spacing: 2px; font-weight: 800;
    padding: 8px 12px;
    background: linear-gradient(90deg, rgba(226,184,74,0.14) 0%, rgba(226,184,74,0.02) 100%);
    border-left: 3px solid #e2b84a;
    border-radius: 0 8px 8px 0;
    display: inline-block;
    text-shadow: 0 0 18px rgba(240,216,120,0.4);
  }
  .count-badge { font-size: 11px; background: var(--surface2); padding: 3px 10px; border-radius: 20px; color: var(--text-muted); }

  /* period selector */
  /* FILTER SYSTEM */
  .filter-section { margin-bottom: 16px; }
  .filter-group-label {
    font-size: 11px;
    color: #f0d878;
    opacity: 1;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 800;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    background: linear-gradient(90deg, rgba(226,184,74,0.14) 0%, rgba(226,184,74,0.02) 100%);
    border-left: 3px solid rgba(226,184,74,0.7);
    border-radius: 0 8px 8px 0;
    text-shadow: 0 0 16px rgba(240,216,120,0.35);
  }
  .filter-group-label span { color: var(--gold); }
  .pill-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
  .fpill {
    padding: 10px 18px;
    border-radius: 22px;
    border: 2px solid rgba(255,255,255,0.28);
    background: rgba(255,255,255,0.07);
    color: rgba(255,255,255,0.85);
    font-size: 13px;
    font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
    letter-spacing: 0.2px;
  }
  .fpill:active { opacity: 0.8; transform: scale(0.96); }
  .fpill.active {
    background: rgba(201,168,76,0.28);
    border-color: var(--gold);
    border-width: 2px;
    color: var(--gold);
    font-weight: 800;
    box-shadow: 0 0 16px rgba(201,168,76,0.45);
  }
  .fpill.quick {
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.18);
    color: var(--text);
    font-weight: 500;
  }
  .fpill.quick.active {
    background: var(--gold);
    color: #0d0f14;
    border-color: var(--gold);
    font-weight: 700;
    box-shadow: 0 0 14px rgba(201,168,76,0.45);
  }
  @keyframes pulse-dot {
    0%, 100% { transform: scale(1); opacity: 1; }
    50%       { transform: scale(1.4); opacity: 0.7; }
  }
  #btn-save-dati.unsaved {
    border-color: #ff4757;
    background: rgba(255,71,87,0.15);
    color: #ff4757;
    box-shadow: 0 0 18px rgba(255,71,87,0.35);
  }
  #btn-save-dati.unsaved #save-dati-dot { display:block !important; }
  .filter-divider { height: 1px; background: var(--border); margin: 10px 0; }
  .compare-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.22s;
    letter-spacing: 0.2px;
    -webkit-tap-highlight-color: transparent;
    margin-left: 6px;   /* doppio gap rispetto alle fpill (gap:6px ‚Üí +6px extra) */
    flex-shrink: 0;
  }
  .compare-btn.off {
    background: linear-gradient(135deg, #1a1f2e, #1e2435);
    border: 1.5px solid #00d2ff;
    color: #00d2ff;
    box-shadow: 0 0 8px rgba(0,210,255,0.25), inset 0 0 8px rgba(0,210,255,0.05);
  }
  .compare-btn.off:active { opacity: 0.75; transform: scale(0.97); }
  .compare-btn.on {
    background: linear-gradient(135deg, #00d2ff, #0077ff);
    border: 1.5px solid #00d2ff;
    color: #fff;
    box-shadow: 0 0 16px rgba(0,210,255,0.55), 0 2px 8px rgba(0,119,255,0.4);
    animation: pulse-compare 2s ease-in-out infinite;
  }
  @keyframes pulse-compare {
    0%, 100% { box-shadow: 0 0 16px rgba(0,210,255,0.55), 0 2px 8px rgba(0,119,255,0.4); }
    50%       { box-shadow: 0 0 28px rgba(0,210,255,0.85), 0 2px 12px rgba(0,119,255,0.6); }
  }
  .compare-btn.on:active { opacity: 0.85; transform: scale(0.97); }
  .compare-icon { font-size: 13px; }

  .active-filter-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(201,168,76,0.08);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 14px;
    font-size: 12px;
    color: var(--gold);
    flex-wrap: wrap;
  }
  .clear-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 6px;
    flex-shrink: 0;
  }
  .period-row { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .period-btn {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .period-btn.active { background: rgba(201,168,76,0.15); border-color: var(--gold); color: var(--gold); font-weight: 600; }

  .progress-bar { height: 4px; background: var(--surface2); border-radius: 2px; margin-top: 6px; }
  .progress-fill { height: 100%; background: var(--gold); border-radius: 2px; transition: width 0.5s; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-top">
      <div class="app-logo-wrap">
        <!-- Icona App -->
        <div class="app-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="3.5" rx="1" fill="rgba(255,255,255,0.92)"/>
            <rect x="3" y="8.5" width="12" height="3" rx="1" fill="rgba(255,255,255,0.72)"/>
            <rect x="3" y="13.5" width="8" height="3" rx="1" fill="rgba(255,255,255,0.52)"/>
            <path d="M17 13l3.5 3.5L17 20" stroke="rgba(255,255,255,0.95)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="20.5" y1="16.5" x2="14" y2="16.5" stroke="rgba(255,255,255,0.95)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="app-title-block">
          <div class="app-title">Analisi Fatturato<span class="title-pro">PRO</span></div>
          <div class="header-subtitle">Applicazione sviluppata da <strong style="-webkit-text-fill-color:rgba(255,255,255,0.82);color:rgba(255,255,255,0.82);font-weight:700">Andrea Muraro</strong></div>
          <div id="header-version">v 2026.02.23 - 13:25</div>
        </div>
      </div>
      <div class="header-actions">
        <button id="btn-carica-dati" onclick="onCaricaDatiClick()" title="Carica Dati salvati" style="display:inline-flex;align-items:center;gap:7px;padding:10px 18px;border-radius:14px;font-family:DM Sans,sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;border:2px solid #74b9ff;background:rgba(116,185,255,0.12);color:#74b9ff">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          Carica Dati
        </button>
        <button id="btn-save-dati" onclick="onSaveDatiClick()" title="Salva Dati" style="display:inline-flex;align-items:center;gap:7px;padding:10px 18px;border-radius:14px;font-family:DM Sans,sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;border:2px solid #4caf82;background:rgba(76,175,130,0.15);color:#4caf82;position:relative">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Salva Dati
          <span id="save-dati-dot" style="display:none;position:absolute;top:-4px;right:-4px;width:10px;height:10px;border-radius:50%;background:#ff4757;border:2px solid var(--surface);animation:pulse-dot 1.5s ease-in-out infinite"></span>
        </button>
        <button id="import-btn" onclick="openImportFlow()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          Importa Excel
        </button>
      </div>
      <input type="file" id="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelected(event)">
      <input type="file" id="session-input" accept=".json,.html" onchange="handleSessionFile(event)">
    </div>
  </header>

  <!-- Status bar metodo salvataggio -->
  <div id="storage-status-bar"></div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('dashboard')">
      <div class="tab-icon" style="background:linear-gradient(135deg,#667eea,#764ba2)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="7" width="4" height="14"/><rect x="17" y="3" width="4" height="18"/></svg>
      </div>
      Dashboard
    </div>
    <div class="tab" onclick="showTab('clienti')">
      <div class="tab-icon" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/><circle cx="19" cy="7" r="2"/><path d="M23 21v-1a3 3 0 00-2-2.83"/></svg>
      </div>
      Clienti
    </div>
    <div class="tab" onclick="showTab('export')">
      <div class="tab-icon" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      Esporta
    </div>
    <div class="tab" onclick="showTab('dati')">
      <div class="tab-icon" style="background:linear-gradient(135deg,#43e97b,#38f9d7)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v6c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/><path d="M3 11v6c0 1.66 4.03 3 9 3s9-1.34 9-3v-6"/></svg>
      </div>
      Database
    </div>
    <div class="tab" onclick="showTab('settings')">
      <div class="tab-icon" style="background:linear-gradient(135deg,#fa8231,#f7971e)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </div>
      Impostazioni
    </div>
  </div>

  <div id="content"></div>
</div>

<!-- MODALS CONTAINER -->
<div id="modals"></div>

<script>
// ============================================================
// STATE
// ============================================================
let DB = {
  datasets: [],   // { id, name, date, rows: [{cliente,fattura,data,importo}] }
};

let currentTab = 'dashboard';
let chartInstances = {};

// ============================================================
// STORAGE
// ============================================================
// ============================================================
// SESSIONE SU FILE (export/import JSON)
// ============================================================
let _unsavedChanges = false;

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let SETTINGS = {
  fileName:            'DB_Analisi_Fatturato_PRO',
  autoSave:            false,
  saveMethod:          '',       // 'dropbox' | 'local' | ''
  dropbox_token:       '',       // access token corrente (si aggiorna automaticamente)
  dropbox_refresh:     '',       // refresh token (permanente)
  dropbox_app_key:     '',       // App Key dalla console Dropbox
  dropbox_app_secret:  '',       // App Secret dalla console Dropbox
  dropbox_token_exp:   0,        // timestamp ms scadenza access token
  fileCounter:         1         // progressivo per i nuovi file
};
// Handle cartella locale (Chrome File System API) ‚Äî non serializzabile, tenuto in memoria
let _dirHandle = null;
(function loadSettings() {
  try {
    const s = localStorage.getItem('vendite_pro_settings');
    if (s) SETTINGS = Object.assign(SETTINGS, JSON.parse(s));
  } catch(e) {}
  setTimeout(() => _renderStorageStatusBar(), 0);
})();
function saveSettings() {
  try { localStorage.setItem('vendite_pro_settings', JSON.stringify(SETTINGS)); } catch(e) {}
  _renderStorageStatusBar();
}

// ‚îÄ‚îÄ Dropbox OAuth: restituisce sempre un access token valido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Se il token √® scaduto (o scadr√† entro 5 min) lo rinnova tramite refresh_token
async function _getValidDropboxToken() {
  const now = Date.now();
  const MARGIN = 5 * 60 * 1000; // 5 minuti di margine

  // Caso 1: token ancora valido
  if (SETTINGS.dropbox_token && SETTINGS.dropbox_token_exp && (SETTINGS.dropbox_token_exp - now) > MARGIN) {
    return SETTINGS.dropbox_token;
  }

  // Caso 2: abbiamo refresh_token + credenziali ‚Üí rinnova
  if (SETTINGS.dropbox_refresh && SETTINGS.dropbox_app_key && SETTINGS.dropbox_app_secret) {
    try {
      const resp = await fetch('https://api.dropbox.com/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type:    'refresh_token',
          refresh_token: SETTINGS.dropbox_refresh,
          client_id:     SETTINGS.dropbox_app_key,
          client_secret: SETTINGS.dropbox_app_secret
        })
      });
      const data = await resp.json();
      if (data.access_token) {
        SETTINGS.dropbox_token     = data.access_token;
        SETTINGS.dropbox_token_exp = now + (data.expires_in || 14400) * 1000;
        saveSettings();
        return SETTINGS.dropbox_token;
      } else {
        const err = data.error_description || data.error || 'Errore rinnovo token';
        throw new Error(err);
      }
    } catch(e) {
      throw new Error('Impossibile rinnovare il token Dropbox: ' + e.message);
    }
  }

  // Caso 3: solo access token manuale (vecchio metodo, nessun refresh)
  if (SETTINGS.dropbox_token) return SETTINGS.dropbox_token;

  throw new Error('Nessun token Dropbox configurato ‚Äî vai in Impostazioni');
}

function markUnsaved() {
  _unsavedChanges = true;
  updateSaveBtn();
  const b = document.getElementById('btn-save-dati');
  if (b) b.classList.add('unsaved');
}
function markSaved() {
  _unsavedChanges = false;
  updateSaveBtn();
  const b = document.getElementById('btn-save-dati');
  if (b) b.classList.remove('unsaved');
}

function showUnsavedModal(onDiscard) {
  // Rimuovi eventuale overlay esistente
  const existing = document.getElementById('unsaved-overlay');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.className = 'unsaved-overlay';
  el.id = 'unsaved-overlay';
  el.innerHTML = `
    <div class="unsaved-sheet">
      <div class="unsaved-icon">‚ö†Ô∏è</div>
      <div class="unsaved-title">Dati non salvati</div>
      <div class="unsaved-sub">Hai importato nuovi dati che non sono stati ancora salvati su file.<br>Se esci senza salvare li perderai.</div>
      <div class="unsaved-actions">
        <button class="unsaved-btn unsaved-btn-save" id="unsaved-save-btn">
          üíæ Salva e continua
        </button>
        <button class="unsaved-btn unsaved-btn-discard" id="unsaved-discard-btn">
          üóëÔ∏è Esci senza salvare
        </button>
        <button class="unsaved-btn unsaved-btn-cancel" id="unsaved-cancel-btn">
          ‚úï Annulla
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(el);

  document.getElementById('unsaved-save-btn').onclick = () => {
    el.remove();
    saveSession();
    // Dopo il salvataggio (download avviato) considera salvato
    markSaved();
  };
  document.getElementById('unsaved-discard-btn').onclick = () => {
    el.remove();
    markSaved(); // reset flag cos√¨ non riappare
    if (typeof onDiscard === 'function') onDiscard();
  };
  document.getElementById('unsaved-cancel-btn').onclick = () => {
    el.remove();
  };
}

function saveSession() {
  if (!DB.datasets.length) {
    toast('Nessun dato da salvare ‚Äî importa prima un file Excel', 'error');
    return;
  }

  // Salva SEMPRE su localStorage prima di tutto ‚Äî backup istantaneo
  save();

  const payload = {
    _version: 2,
    _saved: new Date().toISOString(),
    excludedClients: window._excludedClients || [],
    datasets: DB.datasets.map(ds => ({
      id:          ds.id,
      name:        ds.name,
      date:        ds.date,
      commerciale: ds.commerciale,
      rows: ds.rows.map(r => ({
        cliente:     r.cliente,
        fattura:     r.fattura,
        data:        r.data,
        importo:     r.importo,
        commerciale: r.commerciale
      }))
    }))
  };
  const dataJson = JSON.stringify(payload);
  const ts = new Date().toISOString().slice(0,10);
  const baseName = (SETTINGS.fileName || 'AnalisisFatturatoPRO').trim().replace(/[^a-zA-Z0-9_\-]/g, '_');
  const filename = baseName + '-' + ts + '.html';
  const kb = (dataJson.length / 1024).toFixed(0);

  // Serializza il DOM ‚Äî unico metodo affidabile su Safari con file locali
  const MARKER = 'VENDITE_PRO_DATA_BLOCK';
  const doctype = '<!DOCTYPE html>\n';

  // Rimuovi eventuali dati embedded precedenti dall'HTML corrente
  // Prima rimuovi lo script embedded dal DOM se esiste, poi serializza
  const oldScript = document.getElementById('__vp_data__');
  if (oldScript) oldScript.remove();

  // Crea il nuovo script dati e iniettalo nel <head> PRIMA di serializzare
  const dataEl = document.createElement('script');
  dataEl.id = '__vp_data__';
  dataEl.textContent = 'window.__EMBEDDED_DATA__=' + dataJson + ';';
  document.head.insertBefore(dataEl, document.head.firstChild);

  // Serializza il DOM completo (ora include i dati)
  const finalHTML = doctype + document.documentElement.outerHTML;

  // Rimuovi l'elemento dal DOM live (non serve pi√π, i dati sono in memoria)
  dataEl.remove();

  // Scarica il file
  const blob = new Blob([finalHTML], { type: 'text/html;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);

  toast('\u2713 File .html salvato (' + DB.datasets.length + ' dataset \u00b7 ' + kb + ' KB)');
  markSaved();
}

function loadSession() {
  document.getElementById('session-input').click();
}

// ‚îÄ‚îÄ Salva Dati: gestisce modalit√† e dialogo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onCaricaDatiClick() {
  const method = SETTINGS.saveMethod;
  if (!method || method === 'local') {
    document.getElementById('session-input').click();
    return;
  }
  if (method === 'dropbox')  { loadFromDropbox();  return; }
  document.getElementById('session-input').click();
}

function onSaveDatiClick() {
  if (!DB.datasets.length) {
    toast('Nessun dato da salvare ‚Äî importa prima un file Excel', 'error');
    return;
  }
  const method = SETTINGS.saveMethod;
  if (!method) {
    // Nessun percorso configurato: rimanda alle impostazioni
    showSaveMethodModal();
    return;
  }
  // Per cloud: sincronizza il contatore con i file presenti, poi apri modal
  if (method === 'dropbox') {
    toast('\u23f3 Verifica file sul cloud...');
    _syncCloudCounter(method).then(() => showSaveOptionsModal(method));
  } else {
    showSaveOptionsModal(method);
  }
}

// Interroga il cloud, trova il numero pi√π alto tra i file DB_Analisi_Fatturato_PRO_NNN.json
// e aggiorna SETTINGS.fileCounter di conseguenza
// _cloudFiles: cache dei file cloud (aggiornata ad ogni apertura modal)
// Struttura: [ { name, num, modified } ] ordinati per modified DESC
window._cloudFiles = null;

function _syncCloudCounter(method) {
  const base       = 'DB_Analisi_Fatturato_PRO';
  window._cloudFiles = null; // reset cache

  const extractNum = name => {
    const m = name.match(/DB_Analisi_Fatturato_PRO_(\d+)\.json$/i);
    return m ? parseInt(m[1], 10) : 0;
  };
  const parseFiles = (entries) => {
    return entries
      .filter(f => f.name && f.name.startsWith(base) && extractNum(f.name) > 0)
      .map(f => ({ name: f.name, num: extractNum(f.name), modified: f.modified || f.server_modified || f.lastModifiedDateTime || null }))
      .sort((a, b) => {
        // Ordina per data modifica DESC (pi√π recente prima)
        if (a.modified && b.modified) return new Date(b.modified) - new Date(a.modified);
        return b.num - a.num; // fallback: numero pi√π alto
      });
  };
  const syncCounter = (files) => {
    if (!files.length) return;
    const cloudMax = Math.max(...files.map(f => f.num));
    if (cloudMax > (SETTINGS.fileCounter || 1)) {
      SETTINGS.fileCounter = cloudMax;
      saveSettings();
    }
    window._cloudFiles = files;
  };

  if (method === 'dropbox') {
    return (async () => {
      let token;
      try { token = await _getValidDropboxToken(); } catch(e) { return; }
      const tryList = path => fetch('https://api.dropboxapi.com/2/files/list_folder', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: path, recursive: false })
      }).then(async r => { const t = await r.text(); try { return JSON.parse(t); } catch(e) { return {}; } });

      try {
        let data = await tryList('');
        if (!data || data.error_summary) data = await tryList('/AnalisiFatturatoPRO');
        if (!data || !data.entries) return;
        syncCounter(parseFiles(data.entries.map(f => ({
          name: f.name, num: extractNum(f.name),
          modified: f.server_modified || f.client_modified || null
        }))));
      } catch(e) {}
    })();
  }

  return Promise.resolve();
}

function showSaveMethodModal() {
  const el = document.createElement('div');
  el.id = 'save-method-overlay';
  el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.82);backdrop-filter:blur(8px);z-index:99999;display:flex;align-items:flex-end;justify-content:center';
  el.innerHTML = `
    <div style="background:#1a1f2a;border:2px solid rgba(226,184,74,0.4);border-radius:20px 20px 0 0;padding:28px 24px 44px;width:100%;max-width:480px;animation:slideUpSheet 0.25s cubic-bezier(.2,.9,.4,1)">
      <div style="font-size:22px;text-align:center;margin-bottom:6px">‚öôÔ∏è</div>
      <div style="font-size:17px;font-weight:800;color:#fff;text-align:center;margin-bottom:6px">Percorso di salvataggio non impostato</div>
      <div style="font-size:13px;color:rgba(255,255,255,0.5);text-align:center;margin-bottom:22px">Vai in Impostazioni per scegliere dove salvare i dati</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button onclick="document.getElementById('save-method-overlay').remove();showTab('settings')" style="width:100%;padding:14px;border-radius:14px;font-family:sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#e2b84a,#c9853a);border:none;color:#000">
          ‚öôÔ∏è Vai alle Impostazioni
        </button>
        <button onclick="document.getElementById('save-method-overlay').remove()" style="width:100%;padding:14px;border-radius:14px;font-family:sans-serif;font-size:14px;font-weight:600;cursor:pointer;background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6)">
          Annulla
        </button>
      </div>
    </div>`;
  document.body.appendChild(el);
  el.addEventListener('click', e => { if (e.target === el) el.remove(); });
}

function _methodBigIcon(m) {
  const icons = {
    dropbox:
      '<svg viewBox="0 0 43.1 40.5" width="52" height="52">' +
        '<path fill="#0061ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2z"/>' +
        '<path fill="#0061ff" d="M0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2z"/>' +
        '<path fill="#0061ff" d="M12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/>' +
      '</svg>',

    local:
      '<svg viewBox="0 0 24 24" width="52" height="52" fill="none" stroke="#e2b84a" stroke-width="1.5" stroke-linecap="round">' +
        '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>' +
      '</svg>'
  };
  return icons[m] || 'üíæ';
}

function _methodColor(m) {
  return { dropbox:'#0061ff', local:'#e2b84a' }[m] || '#e2b84a';
}

function showSaveOptionsModal(method) {
  const base     = 'DB_Analisi_Fatturato_PRO';
  const pad      = n => String(n).padStart(3,'0');
  const files    = window._cloudFiles || []; // file cloud con date reali
  // Il file "attuale" √® quello con la data di modifica pi√π recente (index 0 dopo sort)
  const latestFile = files.length ? files[0] : null;
  const latestNum  = latestFile ? latestFile.num : (SETTINGS.fileCounter || 1);
  const nameOver   = latestFile ? latestFile.name : (base + '_' + pad(SETTINGS.fileCounter || 1) + '.json');
  const nameNew    = base + '_' + pad(latestNum + 1) + '.json';
  // Formatta la data dell'ultimo salvataggio
  const latestDate = latestFile && latestFile.modified
    ? new Date(latestFile.modified).toLocaleDateString('it-IT', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' })
    : null;
  const col      = _methodColor(method);
  const tot      = DB.datasets.reduce((s,ds) => s + ds.rows.length, 0);
  const el = document.createElement('div');
  el.id = 'save-opts-overlay';
  el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:flex-end;justify-content:center';
  el.innerHTML =
    '<div style="background:#141820;border:2px solid ' + col + '44;border-radius:24px 24px 0 0;padding:0;width:100%;max-width:480px;animation:slideUpSheet 0.28s cubic-bezier(.2,.9,.4,1);overflow:hidden">' +

    // ‚îÄ‚îÄ Banda colorata in cima con icona grande ‚îÄ‚îÄ
    '<div style="background:linear-gradient(160deg,' + col + '22,' + col + '08);padding:28px 24px 20px;text-align:center;border-bottom:1px solid ' + col + '22">' +
    '<div style="display:inline-flex;align-items:center;justify-content:center;width:80px;height:80px;border-radius:22px;background:' + col + '18;border:2px solid ' + col + '40;margin-bottom:14px">' +
    _methodBigIcon(method) +
    '</div>' +
    '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:' + col + ';margin-bottom:4px">Salvataggio su</div>' +
    '<div style="font-size:22px;font-weight:900;color:#fff;margin-bottom:4px">' + methodLabel(method) + '</div>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.35)">' +
    DB.datasets.length + ' dataset &nbsp;¬∑&nbsp; ' + tot + ' righe' +
    '</div>' +
    '</div>' +

    // ‚îÄ‚îÄ Pulsanti ‚îÄ‚îÄ
    '<div style="padding:20px 24px 40px;display:flex;flex-direction:column;gap:10px">' +
    '<button onclick="window._doSaveOverwrite()" style="width:100%;padding:16px 14px;border-radius:16px;font-size:14px;font-weight:700;cursor:pointer;background:rgba(226,184,74,0.15);border:2px solid rgba(226,184,74,0.6);color:#e2b84a;text-align:left;display:flex;align-items:center;gap:14px;position:relative">' +
    '<span style="font-size:26px;flex-shrink:0">‚ôªÔ∏è</span>' +
    '<div style="flex:1;min-width:0">' +
    '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">' +
    '<div style="font-size:14px;font-weight:800">Sovrascrivi file attuale</div>' +
    (latestDate ? '<span style="font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px;background:rgba(226,184,74,0.25);border:1px solid rgba(226,184,74,0.6);color:#e2b84a;letter-spacing:0.5px">‚≠ê PI√ô RECENTE</span>' : '') +
    '</div>' +
    '<div style="font-size:12px;font-weight:600;color:rgba(226,184,74,0.8);margin-top:3px">' + nameOver + '</div>' +
    (latestDate ? '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">üìÖ Ultimo salvataggio: ' + latestDate + '</div>' : '') +
    (files.length > 1 ? '<div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:1px">' + files.length + ' file presenti sul cloud ¬∑ ordinati per data</div>' : '') +
    '</div>' +
    '</button>' +
    '<button onclick="window._doSaveNew()" style="width:100%;padding:16px 14px;border-radius:16px;font-size:14px;font-weight:700;cursor:pointer;background:rgba(76,175,130,0.12);border:2px solid rgba(76,175,130,0.45);color:#4caf82;text-align:left;display:flex;align-items:center;gap:14px">' +
    '<span style="font-size:26px;flex-shrink:0">‚ú®</span>' +
    '<div><div style="font-size:14px;font-weight:800">Crea nuovo file</div><div style="font-size:11px;font-weight:500;opacity:0.6;margin-top:2px">' + nameNew + '</div></div>' +
    '</button>' +
    '<button onclick="window._closeSaveModal()" style="width:100%;padding:14px;border-radius:16px;font-size:14px;font-weight:600;cursor:pointer;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.45)">' +
    'Annulla' +
    '</button>' +
    '</div>' +
    '</div>';
  document.body.appendChild(el);
  el.addEventListener('click', e => { if (e.target === el) el.remove(); });
}

function methodLabel(m) {
  return { dropbox:'Dropbox', local:'Download locale' }[m] || m;
}

function _renderStorageStatusBar() {
  const bar = document.getElementById('storage-status-bar');
  if (!bar) return;
  const active = SETTINGS.saveMethod || '';

  const methods = [
    {
      id: 'dropbox',
      label: 'Dropbox',
      icon: '<svg viewBox="0 0 43.1 40.5" width="12" height="12"><path fill="currentColor" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>',
      extra: active==='dropbox' && SETTINGS.dropbox_refresh ? ' ¬∑ OAuth' : ''
    },

    {
      id: 'local',
      label: 'Locale',
      icon: '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
      extra: ''
    }
  ];

  bar.innerHTML =
    '<span class="ssb-label">Archiviazione:</span>'
    + methods.map(m => {
        const isActive = active === m.id;
        return '<div class="ssb-item ' + (isActive ? 'active' : 'inactive') + '" title="' + (isActive ? '‚úì Metodo attivo ‚Äî salvataggio e caricamento abilitati' : 'Non attivo ‚Äî configura in Impostazioni') + '">'
          + '<span class="ssb-dot"></span>'
          + m.icon
          + '<span>' + m.label + (isActive && m.extra ? m.extra : '') + '</span>'
        + '</div>';
      }).join('<span class="ssb-sep">¬∑</span>');
}

window._doSaveOverwrite = function() {
  var o = document.getElementById('save-opts-overlay');
  if (o) o.remove();
  doSaveDati('overwrite');
};
window._doSaveNew = function() {
  var o = document.getElementById('save-opts-overlay');
  if (o) o.remove();
  doSaveDati('new');
};
window._closeSaveModal = function() {
  var o = document.getElementById('save-opts-overlay');
  if (o) o.remove();
};

function doSaveDati(mode) {
  if (mode === 'new') {
    SETTINGS.fileCounter = (SETTINGS.fileCounter || 1) + 1;
    saveSettings();
  }
  const method = SETTINGS.saveMethod;
  const pad    = n => String(n).padStart(3,'0');
  const fname  = 'DB_Analisi_Fatturato_PRO_' + pad(SETTINGS.fileCounter || 1) + '.json';
  const json   = JSON.stringify(buildPayload(), null, 2);
  const blob   = new Blob([json], { type: 'application/json' });

  if (method === 'local') {
    _saveLocal(blob, fname);
    return;
  }
  if (method === 'dropbox')  { saveToDropbox(blob, fname);  return; }
}

// ‚îÄ‚îÄ Salvataggio locale: Chrome (File System API) o Safari (Download) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function _saveLocal(blob, fname) {
  // Chrome/Edge: usa il directory handle se disponibile
  if (_dirHandle) {
    try {
      const fileHandle = await _dirHandle.getFileHandle(fname, { create: true });
      const writable   = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      save(); markSaved();
      toast('\u2713 ' + fname + ' salvato in: ' + _dirHandle.name);
      renderSavePathSection(); // aggiorna stato
      return;
    } catch(e) {
      // Permesso scaduto ‚Äî chiedi di riselezionare la cartella
      _dirHandle = null;
      renderSavePathSection();
      toast('Permesso cartella scaduto ‚Äî riseleziona la cartella', 'error');
      return;
    }
  }
  // Fallback: download standard (Safari e tutti i browser senza dir handle)
  _downloadBlob(blob, fname);
  save(); markSaved();
  toast('\u2713 ' + fname + ' scaricato nella cartella Download');
}

function _downloadBlob(blob, fname) {
  const url = URL.createObjectURL(blob);
  const a   = document.createElement('a');
  a.href = url; a.download = fname;
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
}

// ‚îÄ‚îÄ Scegli cartella (Chrome File System API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pickLocalFolder() {
  if (!window.showDirectoryPicker) {
    toast('Selezione cartella non supportata su Safari ‚Äî i file verranno scaricati nella cartella Download', 'error');
    return;
  }
  try {
    const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
    _dirHandle = handle;
    SETTINGS.localFolderName = handle.name;
    saveSettings();
    renderSavePathSection();
    toast('\u2713 Cartella impostata: ' + handle.name);
  } catch(e) {
    if (e.name !== 'AbortError') {
      toast('Errore selezione cartella: ' + e.message, 'error');
    }
  }
}

// ‚îÄ‚îÄ Impostazioni metodo salvataggio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSaveMethod(m) {
  SETTINGS.saveMethod = m;
  if (!SETTINGS.fileCounter) SETTINGS.fileCounter = 1;
  saveSettings();
  renderSettings();
  renderSavePathSection();
  toast('\u2713 Metodo impostato: ' + methodLabel(m));
}

function renderSavePathSection() {
  const el = document.getElementById('save-path-section');
  if (!el) return;
  const m       = SETTINGS.saveMethod;
  const counter = SETTINGS.fileCounter || 1;
  const pad     = n => String(n).padStart(3,'0');
  const fname   = 'DB_Analisi_Fatturato_PRO_' + pad(counter) + '.json';

  const methods = [
    { id:'dropbox',  label:'Dropbox',      color:'#0061ff',
      icon:'<svg viewBox="0 0 43.1 40.5" width="22" height="22"><path fill="#0061ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>' },
    { id:'local',    label:'Download',     color:'#e2b84a',
      icon:'<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#e2b84a" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>' }
  ];

  const tilesHTML = methods.map(mt => {
    const active = m === mt.id;
    const borderCol = active ? mt.color : 'rgba(255,255,255,0.1)';
    const bgCol     = active ? 'rgba(' + (mt.color==='#4285f4'?'66,133,244':'rgba') + ',0.12)' : 'rgba(255,255,255,0.04)';
    const textCol   = active ? mt.color : 'rgba(255,255,255,0.45)';
    const bg = active ? ('rgba(' + (mt.color==='#4285f4'?'66,133,244':mt.color==='#0061ff'?'0,97,255':mt.color==='#0078d4'?'0,120,212':'226,184,74') + ',0.13)') : 'rgba(255,255,255,0.04)';
    return '<button onclick="setSaveMethod(&quot;' + mt.id + '&quot;)" style="padding:14px 8px;border-radius:14px;font-size:11px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:7px;transition:all 0.2s;background:' + bg + ';border:2px solid ' + borderCol + ';color:' + textCol + ';letter-spacing:0.3px">' + mt.icon + mt.label + '</button>';
  }).join('');

  // Token input per cloud
  const isChrome = !!(window.chrome) || ('showDirectoryPicker' in window);
  const tokenHTML = (m && m !== 'local') ? (() => {
    // Dropbox / OneDrive: token manuale con guida dedicata
    const isDropbox   = m === 'dropbox';
    const svcColor    = isDropbox ? '#0061ff' : '#0078d4';
    const hasTokenSvc = !!(SETTINGS[m + '_token']);
    const guideBtn    = 'window._showDropboxGuide()';
    const svcIcon     = isDropbox
      ? '<svg viewBox="0 0 43.1 40.5" width="13" height="13"><path fill="#0061ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>'
      : '';
    return '<div style="margin-top:4px;background:rgba(255,255,255,0.04);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.08)">' +
      '<button onclick="' + guideBtn + '" style="display:flex;align-items:center;gap:10px;width:100%;padding:13px 16px;border-radius:12px;background:linear-gradient(135deg,' + svcColor + '22,' + svcColor + '11);border:2px solid ' + svcColor + '77;color:#fff;cursor:pointer;margin-bottom:14px;text-align:left">' +
      '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="' + svcColor + '" stroke-width="2.5" stroke-linecap="round" style="flex-shrink:0"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>' +
      '<div><div style="font-size:13px;font-weight:800;color:#fff">Come ottenere il Token per ' + methodLabel(m) + '</div>' +
      '<div style="font-size:11px;color:rgba(255,255,255,0.45);margin-top:2px">Guida passo-passo ¬∑ ' + (isDropbox ? '5 minuti' : '10 minuti') + '</div></div>' +
      '</button>' +
      '<div style="display:flex;gap:8px;margin-bottom:8px">' +
      '<input id="sett-token-input" type="password" placeholder="Incolla qui il token..." value="' + (SETTINGS[m + '_token'] || '') + '" style="flex:1;padding:10px 12px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.15);background:rgba(0,0,0,0.3);color:#fff;font-size:13px">' +
      '<button onclick="saveCloudToken()" style="padding:10px 16px;border-radius:10px;background:rgba(226,184,74,0.2);border:1.5px solid rgba(226,184,74,0.5);color:#e2b84a;font-weight:700;font-size:12px;cursor:pointer">Salva</button>' +
      '</div>' +
      (isDropbox ? (
        (() => {
          const hasAll = !!(SETTINGS.dropbox_app_key && SETTINGS.dropbox_app_secret && SETTINGS.dropbox_refresh);
          const hasKey = !!(SETTINGS.dropbox_app_key && SETTINGS.dropbox_app_secret);
          return '<div style="margin-top:10px;padding:14px;background:rgba(0,97,255,0.07);border:1px solid rgba(0,97,255,0.25);border-radius:12px">'
            // Header
            + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">'
              + '<div style="font-size:10px;font-weight:800;color:' + (hasAll ? '#4caf82' : '#4da8ff') + ';text-transform:uppercase;letter-spacing:1px">üîÑ Rinnovo automatico</div>'
              + (hasAll ? '<span style="font-size:10px;font-weight:700;color:#4caf82;background:rgba(76,175,130,0.12);border:1px solid rgba(76,175,130,0.3);border-radius:20px;padding:2px 8px">‚úì Attivo</span>' : '<span style="font-size:10px;color:rgba(255,255,255,0.35)">Non configurato</span>')
            + '</div>'
            // Step 1: App Key + App Secret
            + '<div style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.7);margin-bottom:5px">Passo 1 ‚Äî App Key e App Secret</div>'
            + '<div style="display:flex;flex-direction:column;gap:5px;margin-bottom:10px">'
              + '<input id="sett-db-appkey" type="text" placeholder="App Key (da dropbox.com/developers/apps)" value="' + (SETTINGS.dropbox_app_key || '') + '" style="padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.3);color:#fff;font-size:12px;font-family:monospace">'
              + '<input id="sett-db-appsecret" type="password" placeholder="App Secret" value="' + (SETTINGS.dropbox_app_secret || '') + '" style="padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.3);color:#fff;font-size:12px;font-family:monospace">'
            + '</div>'
            // Step 2: Autorizzazione guidata
            + '<div style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.7);margin-bottom:5px">Passo 2 ‚Äî Ottieni il Refresh Token</div>'
            + '<button onclick="window._startDropboxOAuth()" style="width:100%;padding:10px;border-radius:8px;background:linear-gradient(135deg,rgba(0,97,255,0.25),rgba(0,97,255,0.15));border:1.5px solid rgba(0,97,255,0.6);color:#4da8ff;font-weight:700;font-size:12px;cursor:pointer;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px">'
              + '<svg viewBox="0 0 43.1 40.5" width="14" height="14"><path fill="#4da8ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>'
              + 'üîë Avvia autorizzazione Dropbox'
            + '</button>'
            + '<div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:8px">Dopo aver cliccato Consenti, Dropbox mostrer\u00e0 una pagina con un <strong style="color:rgba(255,255,255,0.65)">codice di accesso</strong>. Copia quel codice (solo il codice, non un URL) e incollalo nel campo qui sotto.</div>'
            + '<div style="display:flex;gap:6px">'
              + '<input id="sett-db-callbackurl" type="text" placeholder="Incolla qui il codice mostrato da Dropbox..." style="flex:1;padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.3);color:#fff;font-size:11px">'
              + '<button onclick="window._extractDropboxCode()" style="padding:8px 12px;border-radius:8px;background:rgba(76,175,130,0.2);border:1.5px solid rgba(76,175,130,0.5);color:#4caf82;font-weight:700;font-size:11px;cursor:pointer;white-space:nowrap">‚Üí Scambia</button>'
            + '</div>'
            // Refresh token manuale (alternativa)
            + '<div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.07);padding-top:8px">'
              + '<div style="font-size:10px;color:rgba(255,255,255,0.35);margin-bottom:5px">Oppure incolla direttamente il Refresh Token se lo hai gi√†:</div>'
              + '<input id="sett-db-refresh" type="password" placeholder="Refresh Token" value="' + (SETTINGS.dropbox_refresh || '') + '" style="width:100%;padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);color:#fff;font-size:12px;font-family:monospace;box-sizing:border-box">'
              + '<button onclick="saveDropboxOAuth()" style="width:100%;margin-top:6px;padding:9px;border-radius:8px;background:rgba(0,97,255,0.2);border:1.5px solid rgba(0,97,255,0.5);color:#4da8ff;font-weight:700;font-size:12px;cursor:pointer">üíæ Salva credenziali OAuth</button>'
            + '</div>'
            + (hasAll ? '<div style="font-size:10px;color:#4caf82;margin-top:8px;text-align:center">‚úì Rinnovo automatico attivo ‚Äî il token si aggiorna ogni 4 ore</div>' : '')
          + '</div>';
        })()
      ) : '') +
      '<div style="display:flex;align-items:center;gap:6px;font-size:11px;margin-top:8px;color:' + (hasTokenSvc ? '#4caf82' : 'rgba(255,255,255,0.3)') + '">' +
      '<span style="width:6px;height:6px;border-radius:50%;background:' + (hasTokenSvc ? '#4caf82' : 'rgba(255,255,255,0.2)') + '"></span>' +
      (hasTokenSvc ? '&#10003; Token presente' : 'Nessun token ‚Äî clicca &quot;Come ottenere il Token&quot; per iniziare') +
      '</div></div>';
  })() : (m === 'local' ? (
    '<div style="margin-top:4px;background:rgba(255,255,255,0.04);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.08)">' +
    '<button onclick="window._showLocalGuide()" style="display:flex;align-items:center;gap:10px;width:100%;padding:13px 16px;border-radius:12px;background:linear-gradient(135deg,rgba(226,184,74,0.18),rgba(226,184,74,0.08));border:2px solid rgba(226,184,74,0.55);color:#fff;cursor:pointer;margin-bottom:14px;text-align:left">' +
    '<svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"none\" stroke=\"#e2b84a\" stroke-width=\"2.5\" stroke-linecap=\"round\" style=\"flex-shrink:0\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 16v-4M12 8h.01\"/></svg>' +
    '<div><div style=\"font-size:13px;font-weight:800;color:#fff\">Come funziona il salvataggio locale</div>' +
    '<div style=\"font-size:11px;color:rgba(255,255,255,0.45);margin-top:2px\">Guida completa ¬∑ Chrome e Safari</div></div>' +
    '</button>' +
    (_dirHandle
      ? ('<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">' +
         '<span style="font-size:18px">üìÅ</span>' +
         '<div><div style="font-size:13px;font-weight:700;color:#4caf82">' + (_dirHandle.name || 'Cartella selezionata') + '</div>' +
         '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">I file verranno salvati in questa cartella</div></div>' +
         '</div>' +
         '<button onclick="pickLocalFolder()" style="width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);font-size:12px;font-weight:600;cursor:pointer">üîÑ Cambia cartella</button>')
      : ('<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:10px">' +
         (isChrome
           ? 'Scegli la cartella dove salvare i file (Chrome supporta la selezione diretta)'
           : 'Su Safari i file vengono scaricati nella cartella <strong style="color:#e2b84a">Download</strong> di default') +
         '</div>' +
         (isChrome
           ? '<button onclick="pickLocalFolder()" style="width:100%;padding:12px;border-radius:10px;background:rgba(226,184,74,0.15);border:2px solid rgba(226,184,74,0.5);color:#e2b84a;font-size:13px;font-weight:700;cursor:pointer">üìÅ Scegli cartella di salvataggio</button>'
           : '<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:rgba(226,184,74,0.08);border:1px solid rgba(226,184,74,0.2)">' +
             '<span style="font-size:18px">üì•</span>' +
             '<div style="font-size:12px;color:rgba(255,255,255,0.6)">I file verranno scaricati automaticamente nella cartella <strong style="color:#e2b84a">Download</strong></div>' +
             '</div>'))) +
    '</div>'
  ) : '');

  // Stato + percorso file locale
  const dot   = m ? '#4caf82' : '#ff4757';
  let pathBox = '';
  if (m === 'local') {
    const folderName = _dirHandle ? _dirHandle.name : (SETTINGS.localFolderName || '');
    const fullPath   = folderName ? folderName + '/' + fname : fname;
    pathBox = '<div style="margin-top:8px;background:rgba(0,0,0,0.3);border:1.5px solid rgba(226,184,74,0.3);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px">' +
      '<span style="font-size:16px;flex-shrink:0">üìÅ</span>' +
      '<div style="flex:1;min-width:0">' +
      '<div style="font-size:10px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:3px">Percorso file</div>' +
      '<div style="font-size:12px;font-weight:700;color:#e2b84a;word-break:break-all;font-family:monospace">' + fullPath + '</div>' +
      (folderName ? '<div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Cartella: ' + folderName + '</div>' : '<div style="font-size:10px;color:rgba(255,71,87,0.7);margin-top:2px">Cartella non selezionata ‚Äî selezionala sopra (Chrome) o il file andr√† in Download</div>') +
      '</div></div>';
  }
  const stato = m
    ? ('Metodo: <strong style="color:rgba(255,255,255,0.8)">' + methodLabel(m) + '</strong>'
       + ' &nbsp;¬∑&nbsp; File: <strong style="color:#e2b84a">' + fname + '</strong>')
    : 'Nessun metodo ‚Äî i dati non vengono salvati su file';

  el.innerHTML =
    '<div style="padding:0 18px 18px;display:flex;flex-direction:column;gap:12px">' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.45);padding-top:16px;padding-bottom:4px">Scegli dove salvare il file <strong style="color:var(--gold)">DB_Analisi_Fatturato_PRO</strong></div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">' + tilesHTML + '</div>' +
    tokenHTML +
    pathBox +
    '<div style="display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,0.4)">' +
    '<span style="width:8px;height:8px;border-radius:50%;background:' + dot + ';flex-shrink:0"></span>' +
    stato + '</div>' +
    '</div>';
}

function saveCloudToken() {
  const inp = document.getElementById('sett-token-input');
  if (!inp) return;
  const key = SETTINGS.saveMethod + '_token';
  SETTINGS[key] = inp.value.trim();
  SETTINGS[SETTINGS.saveMethod + '_token_exp'] = 0; // forza ri-validazione
  saveSettings();
  toast('‚úì Token salvato');
  _renderSaveSettings();
}

// Apre Dropbox per autorizzare e avviare il flusso OAuth
window._startDropboxOAuth = function() {
  const appKey = (document.getElementById('sett-db-appkey') || {}).value || SETTINGS.dropbox_app_key || '';
  if (!appKey.trim()) {
    toast('Inserisci prima l&#39;App Key (Passo 1)', 'error');
    return;
  }
  // Senza redirect_uri: Dropbox mostra il codice direttamente a schermo
  const authUrl = 'https://www.dropbox.com/oauth2/authorize'
    + '?client_id=' + encodeURIComponent(appKey.trim())
    + '&response_type=code'
    + '&token_access_type=offline';
  window.open(authUrl, '_blank');
  toast('Dropbox si apre nel browser. Clicca Consenti, poi copia il codice mostrato e incollalo nel campo qui sotto', 'info');
};

// Estrae il code dall'URL incollato e lo scambia per access+refresh token
window._extractDropboxCode = async function() {
  const urlInput = (document.getElementById('sett-db-callbackurl') || {}).value || '';
  const appKey    = (document.getElementById('sett-db-appkey')     || {}).value || SETTINGS.dropbox_app_key    || '';
  const appSecret = (document.getElementById('sett-db-appsecret')  || {}).value || SETTINGS.dropbox_app_secret || '';

  if (!urlInput.trim()) { toast('Incolla prima l&#39;URL ricevuto da Dropbox', 'error'); return; }
  if (!appKey || !appSecret) { toast('Inserisci App Key e App Secret (Passo 1)', 'error'); return; }

  // Accetta sia il codice puro che un URL contenente code=...
  let code = urlInput.trim();
  if (code.includes('?') || code.includes('&')) {
    // √à un URL: estrai il parametro code
    try {
      const u = new URL(code);
      code = u.searchParams.get('code') || '';
    } catch(e) {
      const m = code.match(/[?&]code=([^&\s]+)/);
      code = m ? m[1] : '';
    }
  }
  // Rimuovi eventuali spazi o caratteri extra
  code = code.replace(/[\s\n\r]/g, '');
  if (!code) { toast('Codice non valido ‚Äî copia il codice mostrato da Dropbox e incollalo qui', 'error'); return; }

  toast('‚è≥ Scambio codice in corso...');
  try {
    const resp = await fetch('https://api.dropbox.com/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        code:          code,
        grant_type:    'authorization_code',
        client_id:     appKey.trim(),
        client_secret: appSecret.trim()
      })
    });
    const data = await resp.json();
    if (data.refresh_token && data.access_token) {
      SETTINGS.dropbox_app_key    = appKey.trim();
      SETTINGS.dropbox_app_secret = appSecret.trim();
      SETTINGS.dropbox_refresh    = data.refresh_token;
      SETTINGS.dropbox_token      = data.access_token;
      SETTINGS.dropbox_token_exp  = Date.now() + (data.expires_in || 14400) * 1000;
      saveSettings();
      toast('‚úÖ Dropbox collegato! Il tuo account Dropbox √® ora attivo ‚Äî salvataggio e caricamento automatici abilitati.', 'ok', 10000);
      setTimeout(() => _renderSaveSettings(), 600);
    } else {
      const err = data.error_description || data.error || 'Risposta inattesa';
      toast('Errore Dropbox: ' + err, 'error');
      console.error('[AFP] OAuth error:', data);
    }
  } catch(e) {
    toast('Errore di rete: ' + e.message, 'error');
  }
};

function saveDropboxOAuth() {
  const appKey    = (document.getElementById('sett-db-appkey')    || {}).value || '';
  const appSecret = (document.getElementById('sett-db-appsecret') || {}).value || '';
  const refresh   = (document.getElementById('sett-db-refresh')   || {}).value || '';
  if (!appKey || !appSecret || !refresh) {
    toast('Compila tutti e tre i campi: App Key, App Secret e Refresh Token', 'error');
    return;
  }
  SETTINGS.dropbox_app_key    = appKey.trim();
  SETTINGS.dropbox_app_secret = appSecret.trim();
  SETTINGS.dropbox_refresh    = refresh.trim();
  SETTINGS.dropbox_token_exp  = 0; // forza rinnovo immediato al prossimo uso
  saveSettings();
  toast('‚úì Credenziali OAuth salvate ‚Äî il token si rinnover√† automaticamente');
  _renderSaveSettings();
}

window._showDropboxGuide = function() {
  if (document.getElementById('dropbox-guide-overlay')) return;
  _showTokenGuide({
    id: 'dropbox-guide-overlay',
    title: 'Come ottenere il Token Dropbox',
    subtitle: 'Dropbox ¬∑ 5 passi semplici ¬∑ circa 5 minuti',
    color: '#0061ff',
    icon: '<svg viewBox="0 0 43.1 40.5" width="28" height="28"><path fill="#0061ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>',
    iconBg: 'rgba(0,97,255,0.15)',
    iconBorder: 'rgba(0,97,255,0.4)',
    steps: [
      { n:'1', title:'Vai alla Dropbox Developer Console',
        desc:'Clicca il pulsante qui sotto per aprire la console sviluppatori di Dropbox. Accedi con il tuo account Dropbox.',
        action:'<a href="https://www.dropbox.com/developers/apps" target="_blank" style="display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:12px;background:rgba(0,97,255,0.2);border:2px solid rgba(0,97,255,0.5);color:#0061ff;font-weight:700;font-size:13px;text-decoration:none">üîó Apri Dropbox Developer</a>',
        note:'' },
      { n:'2', title:'Crea una nuova App',
        desc:'Clicca il pulsante <strong style="color:#fff">Create app</strong>. Scegli <strong style="color:#fff">Scoped access</strong>, poi <strong style="color:#fff">App folder</strong> (accede solo a una cartella dedicata). Nel campo Name scrivi <strong style="color:#e2b84a">AnalisiFatturatoPRO</strong>. Clicca <strong style="color:#fff">Create app</strong>.',
        action:'', note:'üí° Con "App folder" Dropbox crea automaticamente la cartella <strong style="color:#fff">Apps/AnalisiFatturatoPRO</strong> nel tuo Drive ‚Äî i file vengono salvati l√¨.' },
      { n:'3', title:'Imposta i permessi',
        desc:'Nella pagina della tua app clicca la scheda <strong style="color:#fff">Permissions</strong>. Spunta <strong style="color:#e2b84a">files.content.write</strong> e <strong style="color:#e2b84a">files.content.read</strong>. Clicca <strong style="color:#fff">Submit</strong> in fondo.',
        action:'', note:'' },
      { n:'4', title:'Copia App Key e App Secret',
        desc:'Nella scheda <strong style="color:#fff">Settings</strong> trova i campi <strong style="color:#e2b84a">App key</strong> e <strong style="color:#e2b84a">App secret</strong>. Copiali entrambi e incollali nei campi corrispondenti in Impostazioni ‚Üí sezione <strong style="color:#fff">Rinnovo automatico</strong>.',
        action:'', note:'üí° App key e App secret sono le credenziali della tua app ‚Äî non cambiano mai.' },
      { n:'5', title:'Ottieni il Refresh Token',
        desc:'Sempre nella scheda Settings, scorri fino a <strong style="color:#fff">OAuth 2</strong>. Clicca il pulsante qui sotto per avviare il flusso di autorizzazione. Accedi con il tuo account Dropbox e <strong style="color:#e2b84a">copia il codice</strong> che appare alla fine. Poi usa questo codice per ottenere il Refresh Token con la chiamata mostrata di seguito.',
        action:'<div style="background:rgba(0,0,0,0.4);border-radius:8px;padding:10px 14px;font-family:monospace;font-size:10px;color:#a8d8a8;word-break:break-all;margin-top:8px">1. Apri nel browser:<br>https://www.dropbox.com/oauth2/authorize?client_id=TUA_APP_KEY&response_type=code&token_access_type=offline<br><br>2. Dopo l&#39;autorizzazione ricevi un CODE.<br><br>3. Esegui questa chiamata (da terminale o Postman):<br>POST https://api.dropbox.com/oauth2/token<br>body: code=CODE, grant_type=authorization_code, client_id=APP_KEY, client_secret=APP_SECRET<br><br>4. Nella risposta trovi <strong style="color:#e2b84a">refresh_token</strong> ‚Äî incollalo in Impostazioni.</div>',
        note:'‚ö†Ô∏è Il refresh_token non scade mai ‚Äî salvalo in modo sicuro.' },
      { n:'6', title:'Salva le credenziali nell&#39;app',
        desc:'In Impostazioni ‚Üí sezione <strong style="color:#fff">Rinnovo automatico</strong> incolla i tre valori: <strong style="color:#e2b84a">App Key</strong>, <strong style="color:#e2b84a">App Secret</strong> e <strong style="color:#e2b84a">Refresh Token</strong>. Clicca <strong style="color:#fff">Salva credenziali OAuth</strong>.',
        action:'', note:'‚úÖ Da ora il token si rinnova automaticamente ogni 4 ore. Non dovrai pi√π fare nulla.' }
    ],
    footer: { icon:'üîÑ', text:'<strong style="color:#0061ff">Rinnovo automatico:</strong> con App Key + App Secret + Refresh Token il token si rinnova da solo ogni 4 ore ‚Äî nessuna azione richiesta da te.' }
  });
};

// ‚îÄ‚îÄ Guida Download Locale ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._showLocalGuide = function() {
  if (document.getElementById('local-guide-overlay')) return;
  _showTokenGuide({
    id: 'local-guide-overlay',
    title: 'Come funziona il salvataggio locale',
    subtitle: 'Download sul tuo computer ¬∑ nessuna configurazione richiesta',
    color: '#e2b84a',
    icon: '<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#e2b84a" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
    iconBg: 'rgba(226,184,74,0.15)',
    iconBorder: 'rgba(226,184,74,0.4)',
    steps: [
      { n:'üìÅ', title:'Come viene salvato il file',
        desc:'Quando premi <strong style="color:#fff">Salva Dati</strong>, l&#39;app crea un file chiamato <strong style="color:#e2b84a">DB_Analisi_Fatturato_PRO_001.json</strong> e lo scarica sul tuo computer. Ogni volta che crei un nuovo file il numero aumenta: _001, _002, _003...',
        action:'', note:'üí° Il file .json contiene tutti i tuoi dati in formato leggibile. Puoi aprirlo con qualsiasi editor di testo per verificarne il contenuto.' },
      { n:'üìÇ', title:'Su Chrome: scegli la cartella (consigliato)',
        desc:'Se usi <strong style="color:#fff">Google Chrome</strong>, puoi cliccare <strong style="color:#e2b84a">Scegli cartella di salvataggio</strong> qui in basso. Si aprir√† una finestra per selezionare una cartella specifica (es. Documenti/FatturatoPRO). I file verranno salvati direttamente l√¨.',
        action:'', note:'‚ö†Ô∏è La cartella scelta viene dimenticata ogni volta che chiudi il browser. Dovrai riselezionarla una volta per sessione.' },
      { n:'üì•', title:'Su Safari: cartella Download',
        desc:'Su <strong style="color:#fff">Safari</strong> non √® possibile scegliere la cartella di destinazione. I file vengono scaricati automaticamente nella cartella <strong style="color:#e2b84a">Download</strong> del tuo Mac.',
        action:'', note:'üí° Consiglio: crea una cartella <strong style="color:#fff">FatturatoPRO</strong> in Documenti e sposta l√¨ i file dopo il download.' },
      { n:'üîÑ', title:'Come ricaricare i dati alla riapertura',
        desc:'Quando riapri l&#39;app, i dati dell&#39; <strong style="color:#fff">ultima sessione</strong> vengono caricati automaticamente dalla memoria del browser. Se la memoria √® stata svuotata, clicca <strong style="color:#e2b84a">Carica Dati</strong> in alto e seleziona il file .json salvato in precedenza.',
        action:'', note:'' },
      { n:'üíæ', title:'Sovrascrivi o crea un nuovo file',
        desc:'Quando premi <strong style="color:#fff">Salva Dati</strong> puoi scegliere:<br>‚Ä¢ <strong style="color:#e2b84a">Sovrascrivi</strong>: aggiorna il file esistente con i dati attuali<br>‚Ä¢ <strong style="color:#4caf82">Nuovo file</strong>: crea un file con numero progressivo (es. _002.json) mantenendo il precedente come backup',
        action:'', note:'üí° Usa "Nuovo file" prima di importare dati nuovi ‚Äî cos√¨ hai sempre una copia di sicurezza.' }
    ],
    footer: { icon:'üîí', text:'<strong style="color:#e2b84a">Sicurezza:</strong> i dati rimangono solo sul tuo computer. Nessun dato viene inviato a server esterni.' }
  });
};

// ‚îÄ‚îÄ Funzione generica per mostrare le guide ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._closeGuideById = function(btn) {
  var id = btn.getAttribute('data-guide-id');
  var o  = id ? document.getElementById(id) : null;
  if (o) o.remove();
};

function _showTokenGuide(cfg) {
  const el = document.createElement('div');
  el.id = cfg.id;
  el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);backdrop-filter:blur(12px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto';

  const stepsHTML = cfg.steps.map(s =>
    '<div style="display:flex;gap:14px;padding:16px;background:rgba(255,255,255,0.04);border-radius:14px;border:1px solid rgba(255,255,255,0.08)">' +
    '<div style="flex-shrink:0;width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,' + cfg.color + ',' + cfg.color + 'aa);display:flex;align-items:center;justify-content:center;font-size:' + (isNaN(s.n) ? '15px' : '13px') + ';font-weight:800;color:#fff">' + s.n + '</div>' +
    '<div style="flex:1;min-width:0">' +
    '<div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:5px">' + s.title + '</div>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.6);line-height:1.65;margin-bottom:' + ((s.action||s.note) ? '10px' : '0') + '">' + s.desc + '</div>' +
    (s.action ? '<div style="margin-bottom:' + (s.note ? '10px' : '0') + '">' + s.action + '</div>' : '') +
    (s.note ? '<div style="font-size:11px;color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.04);border-radius:8px;padding:8px 10px;line-height:1.5">' + s.note + '</div>' : '') +
    '</div></div>'
  ).join('');

  const closeId = cfg.id;
  el.innerHTML =
    '<div style="background:#141820;border:2px solid ' + cfg.color + '33;border-radius:24px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,0.8)">' +
    '<div style="background:linear-gradient(135deg,' + cfg.color + '22,' + cfg.color + '11);padding:24px 24px 20px;border-bottom:1px solid rgba(255,255,255,0.07);position:sticky;top:0;border-radius:22px 22px 0 0;backdrop-filter:blur(20px)">' +
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">' +
    '<div style="display:flex;align-items:center;gap:14px">' +
    '<div style="width:52px;height:52px;border-radius:14px;background:' + cfg.iconBg + ';border:2px solid ' + cfg.iconBorder + ';display:flex;align-items:center;justify-content:center;flex-shrink:0">' + cfg.icon + '</div>' +
    '<div><div style="font-size:18px;font-weight:900;color:#fff;margin-bottom:3px">' + cfg.title + '</div>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.45)">' + cfg.subtitle + '</div></div>' +
    '</div>' +
    '<button onclick="window._closeGuideById(this)" data-guide-id="' + closeId + '" style="flex-shrink:0;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">&#x2715;</button>' +
    '</div></div>' +
    '<div style="padding:20px 24px 28px;display:flex;flex-direction:column;gap:10px">' +
    stepsHTML +
    '<div style="margin-top:8px;padding:14px;background:' + cfg.color + '11;border:1px solid ' + cfg.color + '33;border-radius:12px;display:flex;gap:10px;align-items:flex-start">' +
    '<span style="font-size:18px;flex-shrink:0">' + cfg.footer.icon + '</span>' +
    '<div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6">' + cfg.footer.text + '</div>' +
    '</div>' +
    '<button onclick="window._closeGuideById(this)" data-guide-id="' + closeId + '" style="width:100%;margin-top:4px;padding:14px;border-radius:14px;background:' + cfg.color + '22;border:2px solid ' + cfg.color + '55;color:' + cfg.color + ';font-weight:700;font-size:14px;cursor:pointer">Ho capito, chiudi la guida</button>' +
    '</div></div>';

  document.body.appendChild(el);
  el.addEventListener('click', e => { if (e.target === el) el.remove(); });
}

// Helper condiviso: applica dati caricati da qualsiasi sorgente
function _applyLoadedData(result, sourceName) {
  if (!result || !result.datasets || !result.datasets.length) {
    toast('File non valido o vuoto', 'error');
    return false;
  }
  DB.datasets = result.datasets;
  window._excludedClients = result.excl || [];
  // Ricalcola dataObj per ogni riga (essenziale per filtri e grafici)
  DB.datasets.forEach(ds => ds.rows.forEach(r => {
    r.dataObj = (r.data && r.data.trim()) ? parseDate(r.data) : null;
  }));
  save(); render(); markSaved();
  showTab('dashboard');
  const tot = DB.datasets.reduce((s, ds) => s + ds.rows.length, 0);
  toast('\u2713 ' + sourceName + ' caricato: ' + DB.datasets.length + ' dataset, ' + tot + ' righe');
  return true;
}

function loadFromDropbox() {
  toast('‚è≥ Ricerca file su Dropbox...');
  _getValidDropboxToken().then(token => _loadFromDropboxWithToken(token)).catch(e => toast(e.message, 'error'));
}

function _loadFromDropboxWithToken(token) {
  // Wrapper sicuro: legge sempre il body come testo, poi tenta JSON
  const dbFetch = (url, opts) => fetch(url, opts).then(async r => {
    const txt = await r.text();
    let json;
    try { json = JSON.parse(txt); } catch(e) { json = null; }
    if (!r.ok) {
      const msg = (json && json.error_summary) ? json.error_summary
                : (json && json.error && json.error['.tag']) ? json.error['.tag']
                : ('HTTP ' + r.status);
      throw new Error(msg);
    }
    return json;
  });

  const tryList = path => dbFetch('https://api.dropboxapi.com/2/files/list_folder', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify({ path: path, recursive: false })
  });

  // Prova prima App Folder root (''), poi cartella nominale come fallback
  tryList('')
    .catch(() => tryList('/AnalisiFatturatoPRO'))
    .then(data => {
      if (!data || !Array.isArray(data.entries)) {
        toast('Errore lettura Dropbox: risposta inattesa', 'error');
        return;
      }
      const base = 'DB_Analisi_Fatturato_PRO';
      const extractNum = name => { const m = name.match(/DB_Analisi_Fatturato_PRO_(\d+)\.json$/i); return m ? parseInt(m[1],10) : 0; };
      const files = data.entries
        .filter(f => f['.tag'] === 'file' && f.name.startsWith(base))
        .map(f => ({ name: f.name, num: extractNum(f.name), path: f.path_lower, modified: f.server_modified || f.client_modified || null }))
        .filter(f => f.num > 0)
        .sort((a, b) => a.modified && b.modified ? new Date(b.modified) - new Date(a.modified) : b.num - a.num);

      if (!files.length) { toast('Nessun file trovato su Dropbox', 'error'); return; }

      const cloudMax = Math.max(...files.map(f => f.num));
      if (cloudMax > (SETTINGS.fileCounter || 1)) { SETTINGS.fileCounter = cloudMax; saveSettings(); }
      window._cloudFiles = files;

      if (files.length === 1) {
        _downloadDropboxFile(files[0].path, files[0].name, token);
      } else {
        _showCloudPickModal(files, 'dropbox', token);
      }
    })
    .catch(e => toast('Errore Dropbox: ' + (e.message || 'controlla il token'), 'error'));
}

async function _downloadDropboxFile(path, fname, tokenArg) {
  toast('‚è≥ Caricamento ' + fname + '...');
  let token;
  try { token = tokenArg || await _getValidDropboxToken(); } catch(e) { toast(e.message, 'error'); return; }
  fetch('https://content.dropboxapi.com/2/files/download', {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + token,
      'Dropbox-API-Arg': JSON.stringify({ path: path })
    }
  })
  .then(async r => {
    const txt = await r.text();
    if (!r.ok) {
      // Dropbox restituisce errori JSON nell'header Dropbox-API-Result o nel body
      let errMsg = 'HTTP ' + r.status;
      try {
        const j = JSON.parse(txt);
        if (j.error_summary) errMsg = j.error_summary;
        else if (j.error && j.error['.tag']) errMsg = j.error['.tag'];
      } catch(e) {}
      throw new Error(errMsg);
    }
    return txt;
  })
  .then(txt => {
    const parsed = _parsePayload(txt);
    if (!parsed) throw new Error('File non valido o corrotto');
    _applyLoadedData(parsed, fname);
  })
  .catch(e => toast('Errore download Dropbox: ' + (e.message || 'file non leggibile'), 'error'));
}


// Modal di selezione file unificato per Dropbox e OneDrive
window._closeCloudPick = function() {
  var o = document.getElementById('cloud-pick-overlay'); if (o) o.remove();
};
window._pickCloud = function(btn) {
  var o = document.getElementById('cloud-pick-overlay'); if (o) o.remove();
  const method = btn.getAttribute('data-method');
  const idx    = parseInt(btn.getAttribute('data-idx'), 10);
  const f      = (window._cloudFiles || [])[idx];
  if (!f) { toast('Errore: file non trovato nella lista', 'error'); return; }
  const token  = SETTINGS.dropbox_token || '';
  if (method === 'dropbox') _downloadDropboxFile(f.path, f.name, token);
};

function _showCloudPickModal(files, method, token) {
  const col    = '#0061ff';
  const label  = 'Dropbox';
  const icon   = method === 'dropbox'
    ? '<svg viewBox="0 0 43.1 40.5" width="18" height="18"><path fill="#0061ff" d="M12.8 0L0 8.2l12.8 8.2 12.8-8.2zM38.3 0L25.5 8.2l12.8 8.2 12.8-8.2zM0 24.7l12.8 8.2 12.8-8.2-12.8-8.2zM38.3 16.5l-12.8 8.2 12.8 8.2 12.8-8.2zM12.8 28.1l12.8 8.2 12.8-8.2-12.8-8.2z"/></svg>'
    : '<svg viewBox="0 0 32 32" width="18" height="18"><path d="M19.2 12.8A7.2 7.2 0 006.4 16H6a6 6 0 000 12h20a5 5 0 000-10 4.98 4.98 0 00-1.1.12A7.2 7.2 0 0019.2 12.8z" fill="#0078d4"/></svg>';

  const el = document.createElement('div');
  el.id = 'cloud-pick-overlay';
  el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:flex-end;justify-content:center';

  const rows = files.map((f, i) => {
    const isNewest = i === 0; // gi√† ordinati per data DESC ‚Äî il primo √® il pi√π recente
    const date = f.modified
      ? new Date(f.modified).toLocaleDateString('it-IT', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' })
      : '‚Äî';
    return '<button onclick="window._pickCloud(this)" data-idx="' + i + '" data-method="' + method + '" style="width:100%;padding:14px 16px;border-radius:14px;background:' + (isNewest ? col + '18' : 'rgba(255,255,255,0.04)') + ';border:' + (isNewest ? '2px solid ' + col + '88' : '1.5px solid rgba(255,255,255,0.1)') + ';color:#fff;text-align:left;cursor:pointer;display:flex;align-items:center;gap:12px">'
      + '<div style="flex:1;min-width:0">'
      + '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">'
      + '<span style="font-size:13px;font-weight:' + (isNewest ? '800' : '600') + ';color:' + (isNewest ? '#fff' : 'rgba(255,255,255,0.7)') + '">' + f.name + '</span>'
      + (isNewest ? '<span style="font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px;background:' + col + '33;border:1px solid ' + col + '77;color:' + col + ';letter-spacing:0.5px">‚≠ê PI√ô RECENTE</span>' : '')
      + '</div>'
      + '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:3px">üìÖ ' + date + '</div>'
      + '</div>'
      + '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>'
      + '</button>';
  }).join('');

  el.innerHTML = '<div style="background:#141820;border:2px solid ' + col + '44;border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:82vh;overflow-y:auto;animation:slideUpSheet 0.28s cubic-bezier(.2,.9,.4,1)">'
    + '<div style="background:linear-gradient(135deg,' + col + '22,' + col + '08);padding:22px 24px 16px;border-bottom:1px solid ' + col + '22;display:flex;align-items:center;gap:12px">'
    + '<div style="width:40px;height:40px;border-radius:12px;background:' + col + '18;border:1.5px solid ' + col + '44;display:flex;align-items:center;justify-content:center">' + icon + '</div>'
    + '<div><div style="font-size:16px;font-weight:900;color:#fff">Scegli file da ' + label + '</div>'
    + '<div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">' + files.length + ' file trovati ¬∑ ordinati per data di modifica</div></div>'
    + '</div>'
    + '<div style="padding:16px 20px 36px;display:flex;flex-direction:column;gap:8px">'
    + rows
    + '<button onclick="window._closeCloudPick()" style="width:100%;margin-top:4px;padding:13px;border-radius:14px;background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.45);font-size:13px;font-weight:600;cursor:pointer">Annulla</button>'
    + '</div></div>';

  document.body.appendChild(el);
  el.addEventListener('click', e => { if (e.target === el) el.remove(); });
}

async function saveToDropbox(blob, fname) {
  let token;
  try { token = await _getValidDropboxToken(); } catch(e) { toast(e.message, 'error'); return; }

  // Step 1: verifica spazio disponibile e validit√† token
  fetch('https://api.dropboxapi.com/2/users/get_space_usage', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: 'null'
  })
  .then(async r => {
    const txt = await r.text();
    try { return JSON.parse(txt); } catch(e) { return {}; }
  })
  .then(usage => {
    if (usage.error_summary) {
      toast('Token Dropbox non valido ‚Äî controlla le credenziali OAuth in Impostazioni', 'error');
      console.error('[AFP] Token check:', usage);
      return;
    }
    // Calcola spazio libero
    const used      = usage.used || 0;
    const allocated = usage.allocation && usage.allocation.allocated ? usage.allocation.allocated : 0;
    const free      = allocated - used;
    console.log('[AFP] Dropbox spazio libero: ' + Math.round(free/1024/1024) + ' MB');
    if (allocated > 0 && free < 1024 * 100) { // meno di 100KB liberi
      toast('Dropbox: spazio insufficiente (' + Math.round(free/1024) + ' KB liberi)', 'error');
      return;
    }
    // Step 2: upload del file
    _dropboxUploadDirect(blob, fname, token);
  })
  .catch(() => {
    // Se check spazio fallisce, prova comunque l'upload
    _dropboxUploadDirect(blob, fname, token);
  });
}

function _dropboxUploadDirect(blob, fname, token) {
  // Converte blob in testo (il file √® JSON quindi √® piccolo)
  blob.text().then(text => {
    const encoder = new TextEncoder();
    const buf     = encoder.encode(text);

    // Prova prima con path App Folder /{fname}
    // poi con /AnalisiFatturatoPRO/{fname} se fallisce
    const tryUpload = (path) => {
      return fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
          Authorization:    'Bearer ' + token,
          'Content-Type':   'application/octet-stream',
          'Dropbox-API-Arg': JSON.stringify({
            path:            path,
            mode:            'overwrite',
            autorename:      false,
            mute:            false
          })
        },
        body: buf
      }).then(r => r.text().then(txt => ({ status: r.status, txt })));
    };

    tryUpload('/' + fname)
    .then(({ status, txt }) => {
      let data;
      try { data = JSON.parse(txt); } catch(e) { data = {}; }
      console.log('[AFP] Dropbox risposta path=/' + fname + ' status=' + status + ':', txt);

      if (status === 200 && (data.id || data.name)) {
        save(); markSaved();
        toast('\u2713 Salvato su Dropbox: ' + fname);
        return;
      }

      // Riprova con path Full Dropbox
      return tryUpload('/AnalisiFatturatoPRO/' + fname)
      .then(({ status: s2, txt: txt2 }) => {
        let d2;
        try { d2 = JSON.parse(txt2); } catch(e) { d2 = {}; }
        console.log('[AFP] Dropbox retry path=/AnalisiFatturatoPRO/ status=' + s2 + ':', txt2);

        if (s2 === 200 && (d2.id || d2.name)) {
          save(); markSaved();
          toast('\u2713 Salvato su Dropbox: ' + fname);
          return;
        }

        // Entrambi falliti ‚Äî mostra errore dettagliato
        const err = (d2.error_summary || data.error_summary || txt2).substring(0, 120);
        toast('Errore Dropbox: ' + err, 'error');
        console.error('[AFP] Dropbox tutti i path falliti. Ultimo errore:', txt2);
      });
    })
    .catch(e => toast('Errore rete Dropbox: ' + e.message, 'error'));
  });
}


// ‚îÄ‚îÄ OneDrive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleSessionFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const result = _parsePayload(ev.target.result);
      if (!result || !result.datasets.length) {
        toast('File non valido ‚Äî non \u00e8 un file Analisi Fatturato PRO', 'error');
        return;
      }
      _applyLoadedData(result, file.name);
    } catch(err) {
      toast('Errore nel leggere il file: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function updateSaveBtn() {
  const btn = document.getElementById('btn-save');
  if (!btn) return;
  if (_unsavedChanges && DB.datasets.length > 0) {
    btn.classList.add('has-data');
    btn.style.borderColor = 'rgba(255,146,43,0.8)';
    btn.style.color = '#ff922b';
    btn.style.background = 'rgba(255,146,43,0.15)';
    btn.title = '‚ö†Ô∏è Dati non salvati ‚Äî clicca per salvare';
    // Aggiungi pallino rosso se non c'√® gi√†
    if (!btn.querySelector('.unsaved-dot')) {
      const dot = document.createElement('span');
      dot.className = 'unsaved-dot';
      dot.style.cssText = 'width:7px;height:7px;background:#ff922b;border-radius:50%;flex-shrink:0;';
      btn.insertBefore(dot, btn.firstChild);
    }
  } else if (DB.datasets.length > 0) {
    btn.classList.add('has-data');
    btn.style.borderColor = 'rgba(76,175,130,0.6)';
    btn.style.color = '#4caf82';
    btn.style.background = 'rgba(76,175,130,0.15)';
    btn.title = 'Salva sessione (' + DB.datasets.length + ' dataset)';
    const dot = btn.querySelector('.unsaved-dot');
    if (dot) dot.remove();
  } else {
    btn.classList.remove('has-data');
    btn.style.cssText = '';
    const dot = btn.querySelector('.unsaved-dot');
    if (dot) dot.remove();
  }
}

// ============================================================
// PERSISTENZA ‚Äî localStorage semplice e affidabile su iOS PWA
// ============================================================
// ============================================================
// CHIAVI localStorage ‚Äî tutte le chiavi usate storicamente
// ============================================================
const LS_KEY      = 'afp_data_v4';   // chiave attuale
const LS_KEYS_OLD = ['analisi_fatturato_pro_v1', 'vendite_pro_v2', 'vendite_pro_v1']; // chiavi vecchie

function buildPayload() {
  return {
    _v: 4,
    _ts: Date.now(),
    excl: window._excludedClients || [],
    ds: DB.datasets.map(ds => ({
      id:   ds.id,
      name: ds.name,
      date: ds.date,
      comm: ds.commerciale,
      rows: ds.rows.map(r => ({
        c: r.cliente,
        f: r.fattura,
        d: r.data,
        i: r.importo,
        v: r.commerciale
      }))
    }))
  };
}

function save() {
  if (!DB.datasets.length) return;
  try {
    const json = JSON.stringify(buildPayload());
    localStorage.setItem(LS_KEY, json);
    // Scrivi anche su tutte le chiavi vecchie per massima compatibilit√†
    LS_KEYS_OLD.forEach(k => { try { localStorage.setItem(k, json); } catch(_) {} });
    console.log('[AFP] ‚úì Salvati ' + DB.datasets.length + ' dataset (' + (json.length/1024).toFixed(0) + ' KB) su localStorage');
  } catch(e) {
    console.error('[AFP] ‚úó Errore salvataggio:', e);
    if (e.name === 'QuotaExceededError') {
      toast('\u26a0\ufe0f Dati troppo grandi per il browser. Esporta un backup Excel.', 'error');
    }
  }
}

function _parsePayload(json) {
  // Accetta sia il formato v4 (chiavi corte) sia il vecchio formato v2/v3
  if (!json) return null;
  try {
    const p = JSON.parse(json);
    if (!p) return null;
    // Formato v4: { _v:4, ds:[...] }
    if (Array.isArray(p.ds)) {
      return {
        excl: Array.isArray(p.excl) ? p.excl : [],
        datasets: p.ds.map(ds => ({
          id:          ds.id,
          name:        ds.name,
          date:        ds.date,
          commerciale: ds.comm || ds.commerciale || '',
          rows: (ds.rows || []).map(r => ({
            cliente:     r.c || r.cliente     || '',
            fattura:     r.f || r.fattura     || '',
            data:        r.d || r.data        || '',
            importo:     r.i !== undefined ? r.i : (r.importo || 0),
            commerciale: r.v || r.commerciale || '',
            dataObj:     null  // ricalcolato dopo
          }))
        }))
      };
    }
    // Formato vecchio v2: { datasets:[...] }
    if (Array.isArray(p.datasets)) {
      return {
        excl: Array.isArray(p.excludedClients) ? p.excludedClients : [],
        datasets: p.datasets
      };
    }
    return null;
  } catch(e) {
    console.error('[AFP] Errore parsing:', e);
    return null;
  }
}

function load() {
  // Prova tutte le chiavi, dalla pi√π recente alla pi√π vecchia
  const allKeys = [LS_KEY, ...LS_KEYS_OLD];
  let parsed = null;
  let foundKey = null;

  for (const key of allKeys) {
    try {
      const json = localStorage.getItem(key);
      if (!json) continue;
      const result = _parsePayload(json);
      if (result && result.datasets && result.datasets.length > 0) {
        parsed = result;
        foundKey = key;
        break;
      }
    } catch(e) { continue; }
  }

  if (!parsed) {
    console.log('[AFP] Nessun dato trovato in localStorage');
    return false; // nessun dato caricato
  }

  // Applica i dati
  DB.datasets = parsed.datasets;
  window._excludedClients = parsed.excl || [];

  // Ricalcola dataObj
  DB.datasets.forEach(ds => ds.rows.forEach(r => {
    r.dataObj = (r.data && r.data.trim()) ? parseDate(r.data) : null;
  }));

  console.log('[AFP] ‚úì Caricati ' + DB.datasets.length + ' dataset da localStorage (chiave: ' + foundKey + ')');

  // Migra alla chiave attuale se trovata su chiave vecchia
  if (foundKey !== LS_KEY) {
    save();
    console.log('[AFP] Migrati dati da ' + foundKey + ' ‚Üí ' + LS_KEY);
  }

  return true; // dati caricati con successo
}

function loadFromIDB() {
  const loaded = load();
  render();
  updateSaveBtn();
  // Toast di conferma solo se ci sono dati effettivi
  if (loaded && DB.datasets.length > 0) {
    setTimeout(() => {
      const tot = DB.datasets.reduce((s, ds) => s + ds.rows.length, 0);
      toast('\u23f3 Database ripristinato: ' + DB.datasets.length + ' dataset, ' + tot + ' righe');
    }, 600);
  }
}

// ============================================================
// ALL ROWS
// ============================================================
function allRows() {
  return DB.datasets.flatMap(ds => ds.rows);
}

// ============================================================
// TABS
// ============================================================
function showTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['dashboard','clienti','export','dati','settings'][i] === tab);
  });
  render();
}

function render() {
  destroyCharts();
  updateSaveBtn();
  const c = document.getElementById('content');
  if (currentTab === 'dashboard') c.innerHTML = renderDashboard();
  else if (currentTab === 'fatture') c.innerHTML = renderFatture();
  else if (currentTab === 'clienti') c.innerHTML = renderClienti();
  else if (currentTab === 'dati') c.innerHTML = renderDati();
  else if (currentTab === 'export') c.innerHTML = renderExport();
  else if (currentTab === 'settings') { c.innerHTML = renderSettings(); renderSavePathSection(); }
  afterRender();
}

function destroyCharts() {
  Object.values(chartInstances).forEach(c => { try { c.destroy(); } catch(e){} });
  chartInstances = {};
}

// ============================================================
// DASHBOARD
// ============================================================
// Palette colori per anno ‚Äî usata sia sui filtri che sul grafico
const ANNO_PALETTE = [
  { base: '#4ecdc4', bg: 'rgba(78,205,196,0.18)',  border: '#4ecdc4', text: '#4ecdc4'  }, // teal
  { base: '#f7b731', bg: 'rgba(247,183,49,0.18)',  border: '#f7b731', text: '#f7b731'  }, // amber
  { base: '#a29bfe', bg: 'rgba(162,155,254,0.18)', border: '#a29bfe', text: '#a29bfe'  }, // lavender
  { base: '#fd79a8', bg: 'rgba(253,121,168,0.18)', border: '#fd79a8', text: '#fd79a8'  }, // pink
  { base: '#55efc4', bg: 'rgba(85,239,196,0.18)',  border: '#55efc4', text: '#55efc4'  }, // mint
  { base: '#e17055', bg: 'rgba(225,112,85,0.18)',  border: '#e17055', text: '#e17055'  }, // coral
  { base: '#74b9ff', bg: 'rgba(116,185,255,0.18)', border: '#74b9ff', text: '#74b9ff'  }, // sky
  { base: '#00b894', bg: 'rgba(0,184,148,0.18)',   border: '#00b894', text: '#00b894'  }, // green
];
function annoColor(annoList, anno) {
  const idx = annoList.indexOf(anno);
  return ANNO_PALETTE[idx % ANNO_PALETTE.length];
}

// Palette distinta per commerciali (colori pi√π saturi/caldi)
const COMM_PALETTE = [
  { base: '#ff6b6b', bg: 'rgba(255,107,107,0.18)', border: '#ff6b6b', text: '#ff6b6b' }, // red
  { base: '#ffd93d', bg: 'rgba(255,217,61,0.18)',  border: '#ffd93d', text: '#ffd93d' }, // yellow
  { base: '#6bcb77', bg: 'rgba(107,203,119,0.18)', border: '#6bcb77', text: '#6bcb77' }, // green
  { base: '#4d96ff', bg: 'rgba(77,150,255,0.18)',  border: '#4d96ff', text: '#4d96ff' }, // blue
  { base: '#ff922b', bg: 'rgba(255,146,43,0.18)',  border: '#ff922b', text: '#ff922b' }, // orange
  { base: '#cc5de8', bg: 'rgba(204,93,232,0.18)',  border: '#cc5de8', text: '#cc5de8' }, // purple
  { base: '#20c997', bg: 'rgba(32,201,151,0.18)',  border: '#20c997', text: '#20c997' }, // teal
  { base: '#f06595', bg: 'rgba(240,101,149,0.18)', border: '#f06595', text: '#f06595' }, // pink
];
function commColor(commList, comm) {
  const idx = commList.indexOf(comm);
  const safeIdx = idx >= 0 ? idx : 0;
  return COMM_PALETTE[safeIdx % COMM_PALETTE.length];
}

// Helper: costruisce le righe della lista clienti Dashboard con badge commerciale
function _buildClientsList(allClients, excl, showAll, filteredRows) {
  const MESI = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  // Mappa cliente ‚Üí commerciale (prende il pi√π frequente)
  const clienteComm = {};
  filteredRows.forEach(r => {
    if (!r.commerciale || r.commerciale === '‚Äî') return;
    if (!clienteComm[r.cliente]) clienteComm[r.cliente] = {};
    clienteComm[r.cliente][r.commerciale] = (clienteComm[r.cliente][r.commerciale]||0) + 1;
  });
  const commsAll = [...new Set(filteredRows.map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
  const getComm = nome => {
    const m = clienteComm[nome];
    if (!m) return null;
    return Object.entries(m).sort((a,b)=>b[1]-a[1])[0][0];
  };

  const slotCount    = showAll ? allClients.length : 20;
  const activeClients = allClients.filter(([n]) => !excl.includes(n)).slice(0, slotCount);
  const exclClients  = allClients.filter(([n]) => excl.includes(n));
  const finalList    = [
    ...activeClients.map((entry, i) => ({ entry, isExcl: false, isSub: i >= 20, isExtra: i >= 20 })),
    ...exclClients.map(entry => ({ entry, isExcl: true, isSub: false, isExtra: false }))
  ];
  const maxVal = activeClients.length ? activeClients[0][1] : (allClients[0] ? allClients[0][1] : 1);

  const rows = finalList.map(({entry: [nome, val], isExcl, isSub, isExtra}) => {
    const barW        = isExcl ? 0 : (val / maxVal * 100).toFixed(1);
    const rank        = allClients.findIndex(([n]) => n === nome) + 1;
    const mc          = rank===1 ? '#e2b84a' : rank===2 ? '#b0b8c8' : rank===3 ? '#c87b4a' : 'rgba(255,255,255,0.22)';
    const safeName    = nome.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const bg          = isExcl ? 'background:rgba(224,92,92,0.12);' : (isExtra ? 'background:rgba(116,185,255,0.04);' : '');
    const borderStyle = isExcl ? 'border:2px solid rgba(224,92,92,0.55);' : (isExtra ? 'border:2px solid rgba(116,185,255,0.12);' : 'border:2px solid transparent;');
    const nameColor   = isExcl ? 'rgba(255,255,255,0.45)' : (isExtra ? 'rgba(255,255,255,0.75)' : '#fff');
    const nameFw      = isExcl ? '500' : '600';
    const amountStyle = isExcl ? 'text-decoration:line-through;color:rgba(255,100,100,0.6)' : '';
    const barColor    = isExcl ? 'rgba(224,92,92,0.35)' : (isExtra ? 'rgba(116,185,255,0.6)' : 'var(--gold)');
    const exclTag     = isExcl
      ? '<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;color:#e05c5c;background:rgba(224,92,92,0.15);border:1px solid rgba(224,92,92,0.4);border-radius:20px;padding:2px 8px;flex-shrink:0;margin-left:4px">‚úï escluso</span>'
      : '';
    const hoverBg     = isExcl ? 'rgba(224,92,92,0.18)' : 'rgba(255,255,255,0.05)';
    const leaveBg     = isExcl ? 'rgba(224,92,92,0.12)' : (isExtra ? 'rgba(116,185,255,0.04)' : 'transparent');

    // Badge commerciale
    const comm    = getComm(nome);
    const commBadge = comm
      ? (() => {
          const col = commColor(commsAll, comm);
          return '<span style="display:inline-flex;align-items:center;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:' + col.bg.replace('0.18','0.25') + ';border:1px solid ' + col.border + '88;color:' + col.text + ';flex-shrink:0;white-space:nowrap;margin-left:6px">' + esc(comm) + '</span>';
        })()
      : '';

    return '<div onclick="(function(){if(!window._excludedClients)window._excludedClients=[];var i=window._excludedClients.indexOf(\'' + safeName + '\');if(i>=0)window._excludedClients.splice(i,1);else window._excludedClients.push(\'' + safeName + '\');markUnsaved();save();_updateDashExclude();})()"'
      + ' style="margin-bottom:8px;cursor:pointer;padding:10px 12px;border-radius:10px;transition:all 0.18s;' + bg + borderStyle + '"'
      + ' onmouseenter="this.style.background=\'' + hoverBg + '\'"'
      + ' onmouseleave="this.style.background=\'' + leaveBg + '\'">'
      + '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:5px;gap:8px">'
        + '<div style="display:flex;align-items:flex-start;gap:7px;min-width:0;flex:1">'
          + '<span style="font-size:11px;font-weight:700;color:' + mc + ';flex-shrink:0;width:18px;text-align:right;margin-top:2px">' + rank + '</span>'
          + '<div style="display:flex;flex-direction:column;gap:4px;min-width:0">'
            + '<span style="font-size:13px;font-weight:' + nameFw + ';color:' + nameColor + ';word-break:break-word;line-height:1.3">' + esc(nome) + '</span>'
            + ((commBadge || exclTag) ? '<div style="display:flex;flex-wrap:wrap;gap:4px">' + commBadge + exclTag + '</div>' : '')
          + '</div>'
        + '</div>'
        + '<span class="amount" style="font-size:13px;flex-shrink:0;margin-top:2px;' + amountStyle + '">' + fmtEur(val) + '</span>'
      + '</div>'
      + '<div style="background:rgba(255,255,255,0.08);border-radius:4px;height:5px;overflow:hidden">'
        + '<div style="background:' + barColor + ';height:100%;width:' + barW + '%;border-radius:4px;transition:width 0.4s ease"></div>'
      + '</div>'
      + '</div>';
  }).join('');

  const extraCount = allClients.length - 20;
  const toggleBtn = extraCount > 0
    ? '<div style="margin-top:14px">'
      + '<button onclick="window._showAllClients=!' + showAll + ';render()"'
      + ' style="width:100%;padding:13px;border-radius:14px;cursor:pointer;font-family:sans-serif;font-size:13px;font-weight:700;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:8px;'
      + (showAll
          ? 'background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.6);'
          : 'background:linear-gradient(135deg,rgba(116,185,255,0.15),rgba(116,185,255,0.08));border:2px solid rgba(116,185,255,0.45);color:#74b9ff;box-shadow:0 2px 12px rgba(116,185,255,0.15);')
      + '">'
      + (showAll
          ? '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg> Mostra solo Top 20'
          : '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg> Mostra tutti i ' + allClients.length + ' clienti')
      + '</button>'
      + '</div>'
    : '';

  return rows + toggleBtn;
}

function renderDashboard() {
  const rows = allRows();
  if (!rows.length) return emptyState('üìä','Nessun dato ancora','Importa il tuo primo file Excel per vedere la dashboard');

  const MESI = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];

  // ‚îÄ‚îÄ Stato filtri ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!window._df) window._df = { anni: [], mesi: [], quick: null };
if (!window._excludedClients) window._excludedClients = [];
if (window._showAllClients === undefined) window._showAllClients = false;
  if (window._dfCompare === undefined) window._dfCompare = false;
  const compareMode = window._dfCompare;
  const df = window._df;

  // ‚îÄ‚îÄ Anni disponibili dai dati ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const anniDisp = [...new Set(rows.filter(r=>r.dataObj).map(r=>r.dataObj.getFullYear()))].sort((a,b)=>a-b);
  const commsDisp = [...new Set(rows.map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();

  // ‚îÄ‚îÄ Filtro commerciale (array per multi-selezione) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!window._dfComm) window._dfComm = [];
  if (typeof window._dfComm === 'string') window._dfComm = window._dfComm ? [window._dfComm] : [];
  const dfComm = window._dfComm;
  const rowsBase = dfComm.length ? rows.filter(r => dfComm.includes(r.commerciale||'')) : rows;

  // ‚îÄ‚îÄ Se quick attivo, ignora anni/mesi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let filtered;
  if (df.quick) {
    const now = new Date();
    const m = parseInt(df.quick);
    // Inizio del mese corrente (escluso) ‚Üí inizio del mese N mesi fa (incluso)
    // Es: oggi Feb 2026, "3 mesi" ‚Üí da 1 Nov 2025 a 31 Gen 2026 (3 mesi esatti, Feb escluso)
    const startOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const cutoff = new Date(now.getFullYear(), now.getMonth() - m, 1);
    filtered = rowsBase.filter(r => r.dataObj && r.dataObj >= cutoff && r.dataObj < startOfCurrentMonth);
  } else {
    // Filtra per anni selezionati
    let byAnno = (df.anni.length === 0)
      ? rowsBase
      : rowsBase.filter(r => r.dataObj && df.anni.includes(r.dataObj.getFullYear()));

    // Mesi comuni tra gli anni selezionati (se pi√π anni scelti)
    let mesiDisp = [];
    if (df.anni.length === 0) {
      mesiDisp = [...new Set(rows.filter(r=>r.dataObj).map(r=>r.dataObj.getMonth()))].sort((a,b)=>a-b);
    } else if (df.anni.length === 1) {
      mesiDisp = [...new Set(byAnno.filter(r=>r.dataObj).map(r=>r.dataObj.getMonth()))].sort((a,b)=>a-b);
    } else {
      // Intersezione mesi tra tutti gli anni selezionati
      const mesiPerAnno = df.anni.map(a => new Set(rows.filter(r=>r.dataObj && r.dataObj.getFullYear()===a).map(r=>r.dataObj.getMonth())));
      mesiDisp = [...mesiPerAnno[0]].filter(m => mesiPerAnno.every(s => s.has(m))).sort((a,b)=>a-b);
    }
    window._mesiDisp = mesiDisp;

    // Filtra per mesi selezionati
    filtered = (df.mesi.length === 0)
      ? byAnno
      : byAnno.filter(r => r.dataObj && df.mesi.includes(r.dataObj.getMonth()));
  }

  const totalF = filtered.reduce((s,r) => s + r.importo, 0);
  const clientiTot = new Set(rows.map(r=>r.cliente)).size;

  // ‚îÄ‚îÄ Monthly chart data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const monthly = {};
  filtered.forEach(r => {
    if (!r.dataObj) return;
    const k = r.dataObj.getFullYear() + '-' + String(r.dataObj.getMonth()+1).padStart(2,'0');
    monthly[k] = (monthly[k] || 0) + r.importo;
  });
  // Nessun limite artificiale: mostra tutti i mesi del periodo selezionato
  const months = Object.keys(monthly).sort();

  // ‚îÄ‚îÄ Top clienti ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const byClient = {};
  filtered.forEach(r => { byClient[r.cliente] = (byClient[r.cliente]||0) + r.importo; });
  const allClients = Object.entries(byClient).sort((a,b)=>b[1]-a[1]);
  const topClients = allClients.slice(0,20); // base per ranking

  // ‚îÄ‚îÄ Mesi disponibili (per il secondo livello di filtro) ‚îÄ‚îÄ‚îÄ
  const mesiDisp = window._mesiDisp || [];

  // ‚îÄ‚îÄ Descrizione filtro attivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let filterDesc = '';
  if (df.quick) {
    filterDesc = `Ultimi ${df.quick} mesi`;
  } else if (df.anni.length || df.mesi.length) {
    const aLabel = df.anni.length ? df.anni.join(', ') : 'Tutti gli anni';
    const mLabel = df.mesi.length ? df.mesi.map(m=>MESI[m]).join(', ') : 'Tutti i mesi';
    filterDesc = aLabel + ' ¬∑ ' + mLabel;
  }

  return `
    <!-- FILTRI -->
    <div class="filter-section">

      ${filterDesc ? `
      <div class="active-filter-bar">
        <span>üìÖ</span>
        <span>${filterDesc}</span>
        <button class="clear-btn" onclick="window._df={anni:[],mesi:[],quick:null};window._mesiDisp=[];render()">‚úï Reset</button>
      </div>` : ''}

      <!-- Commerciale filter -->
      ${(function(){
        const comms = [...new Set(allRows().map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
        if (!comms.length) return '';
        if (!window._dfComm) window._dfComm = [];
        if (typeof window._dfComm === 'string') window._dfComm = window._dfComm ? [window._dfComm] : [];
        const dfC = window._dfComm;
        const multiActive = dfC.length >= 2;
        return '<div class="filter-group-label" style="display:flex;align-items:center;justify-content:space-between">'
          + '<span>üßë‚Äçüíº Commerciale <span style="font-size:10px;color:var(--text-muted);font-weight:400">' + (multiActive ? '‚áÑ confronto attivo' : '') + '</span></span>'
          + '</div>'
          + '<div class="pill-row" style="margin-bottom:8px;align-items:center">'
          + '<button class="fpill ' + (!dfC.length ? 'active' : '') + '" onclick="window._dfComm=[];render()">Tutti</button>'
          + comms.map(c => {
              const isActive = dfC.includes(c);
              const col = commColor(comms, c);
              const bg   = isActive ? col.bg.replace('0.18','0.30') : 'rgba(255,255,255,0.07)';
              const bord = isActive ? col.border : col.border + 'aa';
              const clr  = isActive ? col.text   : '#ffffffcc';
              const fw   = isActive ? '800' : '500';
              const glow = isActive ? ';box-shadow:0 0 14px ' + col.border + '66' : '';
              return '<button class="fpill" style="background:' + bg + ';border-color:' + bord + ';color:' + clr + ';font-weight:' + fw + glow + '" onclick="(function(){if(!window._dfComm)window._dfComm=[];if(typeof window._dfComm===\'string\')window._dfComm=window._dfComm?[window._dfComm]:[];var i=window._dfComm.indexOf(\'' + c.replace(/'/g,"\\'") + '\');if(i>=0)window._dfComm.splice(i,1);else window._dfComm.push(\'' + c.replace(/'/g,"\\'") + '\');render();})()">\u200b' + esc(c) + '</button>';
            }).join('')
          + '</div><div class="filter-divider"></div>';
      })()}

      <!-- Scorciatoie rapide -->
      <div class="filter-group-label">Scorciatoie rapide</div>
      <div class="pill-row">
        ${[['3','Ultimi 3 mesi'],['6','Ultimi 6 mesi'],['9','Ultimi 9 mesi'],['12','Ultimi 12 mesi']].map(([v,l]) =>
          `<button class="fpill quick ${df.quick===v?'active':''}" onclick="window._df={anni:[],mesi:[],quick:'${v}'};render()">${l}</button>`
        ).join('')}
      </div>

      <div class="filter-divider"></div>

      <!-- Selezione Anno -->
      <div class="filter-group-label">Anno <span>${df.anni.length ? df.anni.join(', ') : 'tutti'}</span></div>
      <div class="pill-row" style="align-items:center">
        ${anniDisp.map(a => {
          const c = annoColor(anniDisp, a);
          const isActive = df.anni.includes(a);
          const bg   = isActive ? c.bg.replace('0.18','0.30') : 'rgba(255,255,255,0.07)';
          const bord = isActive ? c.border : c.border + 'aa';
          const col  = isActive ? c.text   : '#ffffffcc';
          const fw   = isActive ? '800' : '500';
          const glow = isActive ? ';box-shadow:0 0 14px ' + c.border + '66' : '';
          return '<button class="fpill" style="background:' + bg + ';border-color:' + bord + ';color:' + col + ';font-weight:' + fw + glow + '" onclick="(function(){var df=window._df;df.quick=null;var i=df.anni.indexOf(' + a + ');if(i>=0)df.anni.splice(i,1);else df.anni.push(' + a + ');df.anni.sort();df.mesi=[];window._dfCompare=false;render();})()">'+a+'</button>';
        }).join('')}
        ${df.anni.length >= 2
          ? '<button class="compare-btn ' + (compareMode ? 'on' : 'off') + '" onclick="window._dfCompare=!' + compareMode + ';render()">'
            + '<span class="compare-icon">‚áÑ</span>'
            + (compareMode ? 'Confronto attivo' : 'Confronta anni')
            + '</button>'
          : ''}
      </div>

      <!-- Selezione Mese (solo se almeno un anno selezionato) -->
      ${df.anni.length > 0 && !df.quick ? `
      <div class="filter-divider"></div>
      <div class="filter-group-label">Mese <span>${df.mesi.length ? df.mesi.map(m=>MESI[m]).join(', ') : 'tutti'}</span></div>
      <div class="pill-row">
        ${mesiDisp.map(m => {
          const c = df.anni.length === 1 ? annoColor(anniDisp, df.anni[0]) : { bg:'rgba(201,168,76,0.18)', border:'#c9a84c', text:'#c9a84c' };
          const isActive = df.mesi.includes(m);
          const bg = isActive ? c.bg : 'transparent';
          const bord = isActive ? c.border : c.border + '50';
          const col = isActive ? c.text : c.text + '80';
          const fw = isActive ? '600' : '400';
          return '<button class="fpill" style="background:' + bg + ';border-color:' + bord + ';color:' + col + ';font-weight:' + fw + '" onclick="(function(){var df=window._df;df.quick=null;var i=df.mesi.indexOf(' + m + ');if(i>=0)df.mesi.splice(i,1);else df.mesi.push(' + m + ');render();})()">'+MESI[m]+'</button>';
        }).join('')}
      </div>` : ''}

    </div>

    ${months.length >= 1 ? `
    <div class="card">
      <div style="margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div class="card-title" style="margin-bottom:0">Fatturato mensile</div>
          ${(function(){
            const dc = window._dfComm||[];
            const cc = window._dfCompare && df.anni.length >= 2;
            if (cc) return '<span style="font-size:10px;background:rgba(162,155,254,0.15);color:#a29bfe;border:1px solid rgba(162,155,254,0.4);padding:3px 10px;border-radius:20px;font-weight:600">‚áÑ Confronto per mese</span>';
            return '';
          })()}
        </div>
        ${(function(){
          // Commerciali SOPRA il grafico
          const dc = window._dfComm || [];
          if (!dc.length) return '';
          return '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px">'
            + dc.map(comm => {
                const c = commColor(commsDisp, comm);
                return '<span style="display:inline-flex;align-items:center;gap:6px;padding:5px 13px;border-radius:20px;border:2px solid ' + c.border + ';background:' + c.bg + ';color:' + c.text + ';font-size:11px;font-weight:700;font-family:DM Sans,sans-serif">'
                  + '<span style="width:8px;height:8px;border-radius:50%;background:' + c.border + ';flex-shrink:0"></span>'
                  + esc(comm) + '</span>';
              }).join('')
            + '</div>';
        })()}
      </div>
      <div id="dash-chart-wrap" class="chart-wrap" style="${compareMode && df.anni.length >= 2 ? 'height:260px' : ''}"><canvas id="chart-monthly"></canvas></div>
      ${(function(){
        // Anni SOTTO il grafico (sempre, se non √® quick filter)
        if (df.quick) return '';
        const anniMostrati = df.anni.length ? df.anni : anniDisp;
        if (!anniMostrati.length) return '';
        return '<div id="chart-legend-pills" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;justify-content:center">'
          + anniMostrati.map(a => {
              const c = annoColor(anniDisp, a);
              return '<span style="display:inline-flex;align-items:center;gap:6px;padding:5px 13px;border-radius:20px;border:2px solid ' + c.border + ';background:' + c.bg + ';color:' + c.text + ';font-size:11px;font-weight:700;font-family:DM Sans,sans-serif">'
                + '<span style="width:8px;height:8px;border-radius:50%;background:' + c.border + ';flex-shrink:0"></span>'
                + a + '</span>';
            }).join('')
          + '</div>';
      })()}

      <!-- Box media mensile sotto il grafico -->
      <div id="dash-media-box">${(function(){
        if (months.length < 1) return '';
        const numMesi = months.length;
        const dfC = window._dfComm || [];
        const excl = window._excludedClients || [];
        const filtEx = filtered.filter(r => !excl.includes(r.cliente));

        // Caso 1: nessun commerciale selezionato o uno solo ‚Üí un box unico
        if (dfC.length <= 1) {
          const mediaM = numMesi > 0 ? (filtEx.reduce((s,r)=>s+r.importo,0) / numMesi) : 0;
          const label = dfC.length === 1 ? 'üìä Media mensile ¬∑ ' + esc(dfC[0]) : 'üìä Media mensile';
          return '<div style="margin-top:16px;display:grid;grid-template-columns:1fr;gap:10px">'
            + '<div class="kpi-card" style="border-color:rgba(226,184,74,0.3);background:rgba(226,184,74,0.06)">'
              + '<div class="kpi-label">' + label + '</div>'
              + '<div class="kpi-value">' + fmtK(mediaM) + '</div>'
              + '<div class="kpi-sub">' + fmtEur(mediaM) + ' ¬∑ su ' + numMesi + ' mes' + (numMesi===1?'e':'i') + '</div>'
            + '</div>'
          + '</div>';
        }

        // Caso 2: pi√π commerciali selezionati ‚Üí un box per ciascuno
        const comms = [...new Set(allRows().map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
        return '<div style="margin-top:16px">'
          + '<div style="font-size:10px;color:#c9a84c;text-transform:uppercase;letter-spacing:1.3px;font-weight:800;margin-bottom:8px">üìä Media mensile per commerciale in base al periodo selezionato</div>'
          + '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">'
          + dfC.map(comm => {
              const col = commColor(comms, comm);
              const commRows = filtEx.filter(r => (r.commerciale||'') === comm);
              const commMonths = new Set(commRows.filter(r=>r.dataObj).map(r => r.dataObj.getFullYear()+'-'+String(r.dataObj.getMonth()+1).padStart(2,'0'))).size || 1;
              const commTotale = commRows.reduce((s,r)=>s+r.importo,0);
              const commMedia = commTotale / commMonths;
              return '<div class="kpi-card" style="border-color:' + col.border + '55;background:' + col.bg.replace('0.18','0.08') + '">'
                + '<div class="kpi-label" style="color:' + col.text + ';overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + esc(comm) + '</div>'
                + '<div class="kpi-value" style="color:' + col.text + ';font-size:18px">' + fmtK(commMedia) + '</div>'
                + '<div class="kpi-sub">' + fmtEur(commMedia) + ' ¬∑ ' + commMonths + ' mes' + (commMonths===1?'e':'i') + '</div>'
              + '</div>';
            }).join('')
          + '</div>'
        + '</div>';
      })()}</div>

      <!-- KPI ‚Äî spostati sotto la media mensile -->
      <div id="dash-kpi-row" class="kpi-row" style="margin-top:16px;margin-bottom:0">
        <div class="kpi-card">
          <div class="kpi-label">Fatturato</div>
          <div id="dash-kpi-fatturato" class="kpi-value">${fmtK(totalF)}</div>
          <div id="dash-kpi-fatturato-sub" class="kpi-sub">${fmtEur(totalF)}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Fatture</div>
          <div id="dash-kpi-fatture" class="kpi-value">${filtered.length}</div>
          <div class="kpi-sub">nel periodo</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Clienti attivi</div>
          <div id="dash-kpi-clienti" class="kpi-value">${new Set(filtered.map(r=>r.cliente)).size}</div>
          <div id="dash-kpi-clienti-sub" class="kpi-sub">totale: ${clientiTot}</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Media fattura</div>
          <div id="dash-kpi-media" class="kpi-value">${fmtK(filtered.length ? totalF/filtered.length : 0)}</div>
          <div class="kpi-sub">per fattura</div>
        </div>
      </div>
    </div>` : ''}

    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
        <div class="card-title" style="margin-bottom:0">üèÖ Top 20 clienti</div>
        <span id="dash-excl-badge" style="display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap">${(window._excludedClients||[]).length > 0 ? `
          <span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;color:#e05c5c;background:rgba(224,92,92,0.15);border:1.5px solid rgba(224,92,92,0.45);border-radius:20px;padding:3px 10px">
            ‚úï ${(window._excludedClients||[]).length} esclus${(window._excludedClients||[]).length===1?'o':'i'}
          </span>
          <button onclick="window._excludedClients=[];markUnsaved();save();_updateDashExclude()"
            style="display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;border:1.5px solid rgba(76,175,130,0.55);background:rgba(76,175,130,0.12);color:#4caf82;cursor:pointer;font-family:DM Sans,sans-serif;transition:all 0.18s"
            onmouseenter="this.style.background='rgba(76,175,130,0.22)'"
            onmouseleave="this.style.background='rgba(76,175,130,0.12)'">
            ‚Ü∫ Ripristina tutti
          </button>` : ''}</span>
      </div>
      <div id="dash-clients-list">${_buildClientsList(allClients, window._excludedClients||[], window._showAllClients||false, filtered)}</div>
    </div>

    <div class="card">
      <div class="card-title">Distribuzione clienti</div>
      <div class="chart-wrap" style="height:200px"><canvas id="chart-pie"></canvas></div>
    </div>
  `;
}

// Aggiorna KPI, grafico e media mensile al toggle esclusione cliente
function _updateDashExclude() {
  if (currentTab !== 'dashboard') { render(); return; }
  const rows = allRows();
  if (!rows.length) return;

  // Ricalcola filtered con lo stesso stato corrente dei filtri
  const df       = window._df || { anni:[], mesi:[], quick:null };
  const dfComm   = window._dfComm || [];
  const rowsBase = dfComm.length ? rows.filter(r => dfComm.includes(r.commerciale||'')) : rows;
  let filtered;
  if (df.quick) {
    const now  = new Date();
    const cutoff = new Date(now.getFullYear(), now.getMonth() - parseInt(df.quick), 1);
    const startOfCurr = new Date(now.getFullYear(), now.getMonth(), 1);
    filtered = rowsBase.filter(r => r.dataObj && r.dataObj >= cutoff && r.dataObj < startOfCurr);
  } else {
    let byAnno = df.anni.length ? rowsBase.filter(r => r.dataObj && df.anni.includes(r.dataObj.getFullYear())) : rowsBase;
    filtered = df.mesi.length ? byAnno.filter(r => r.dataObj && df.mesi.includes(r.dataObj.getMonth())) : byAnno;
  }

  // Applica esclusioni
  const excl         = window._excludedClients || [];
  const filteredNoEx = filtered.filter(r => !excl.includes(r.cliente));
  const totalF       = filteredNoEx.reduce((s,r) => s + r.importo, 0);
  const clientiAtt   = new Set(filteredNoEx.map(r => r.cliente)).size;
  const clientiTot   = new Set(rows.map(r => r.cliente)).size;

  // ‚îÄ‚îÄ KPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  set('dash-kpi-fatturato',     fmtK(totalF));
  set('dash-kpi-fatturato-sub', fmtEur(totalF));
  set('dash-kpi-fatture',       filteredNoEx.length);
  set('dash-kpi-clienti',       clientiAtt);
  set('dash-kpi-clienti-sub',   'totale: ' + clientiTot);
  set('dash-kpi-media',         fmtK(filteredNoEx.length ? totalF / filteredNoEx.length : 0));

  // ‚îÄ‚îÄ Lista clienti ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const listEl = document.getElementById('dash-clients-list');
  if (listEl) {
    const byClient = {};
    filtered.forEach(r => { byClient[r.cliente] = (byClient[r.cliente]||0) + r.importo; });
    const allClients = Object.entries(byClient).sort((a,b) => b[1]-a[1]);
    listEl.innerHTML = _buildClientsList(allClients, excl, window._showAllClients || false, filtered);
  }

  // ‚îÄ‚îÄ Badge "X esclusi" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const badgeWrap = document.getElementById('dash-excl-badge');
  if (badgeWrap) {
    badgeWrap.innerHTML = excl.length
      ? '<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;color:#e05c5c;background:rgba(224,92,92,0.15);border:1.5px solid rgba(224,92,92,0.45);border-radius:20px;padding:3px 10px">‚úï ' + excl.length + ' esclus' + (excl.length===1?'o':'i') + '</span>'
        + '<button onclick="window._excludedClients=[];markUnsaved();save();_updateDashExclude()" style="display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;border:1.5px solid rgba(76,175,130,0.55);background:rgba(76,175,130,0.12);color:#4caf82;cursor:pointer">‚Ü∫ Ripristina tutti</button>'
      : '';
  }

  // ‚îÄ‚îÄ Grafico mensile (chart-monthly) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _refreshMonthlyChart(filteredNoEx, filtered);

  // ‚îÄ‚îÄ Media mensile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _refreshMediaBox(filteredNoEx, filtered);
}

function _refreshMonthlyChart(filteredRows, filteredAll) {
  // Delega a _buildMonthlyChart che gestisce tutti i casi (confronto anni, confronto comm, normale)
  _buildMonthlyChart(filteredRows, allRows(), filteredAll || filteredRows);
}

function _refreshMediaBox(filteredNoEx, filteredAll) {
  const box = document.getElementById('dash-media-box');
  if (!box) return;
  const MESI_SHORT = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  const dfC   = window._dfComm || [];
  const comms = [...new Set(allRows().map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();

  // Calcola i mesi distinti presenti in filteredAll (stessa base del grafico)
  const monthsSet = new Set(filteredAll.filter(r=>r.dataObj).map(r =>
    r.dataObj.getFullYear() + '-' + String(r.dataObj.getMonth()+1).padStart(2,'0')
  ));
  const numMesi = monthsSet.size;
  if (numMesi < 1) { box.innerHTML = ''; return; }

  if (dfC.length <= 1) {
    const mediaM = filteredNoEx.reduce((s,r) => s+r.importo, 0) / numMesi;
    const label  = dfC.length === 1 ? 'üìä Media mensile ¬∑ ' + esc(dfC[0]) : 'üìä Media mensile';
    box.innerHTML = '<div style="margin-top:16px;display:grid;grid-template-columns:1fr;gap:10px">'
      + '<div class="kpi-card" style="border-color:rgba(226,184,74,0.3);background:rgba(226,184,74,0.06)">'
        + '<div class="kpi-label">' + label + '</div>'
        + '<div class="kpi-value">' + fmtK(mediaM) + '</div>'
        + '<div class="kpi-sub">' + fmtEur(mediaM) + ' ¬∑ su ' + numMesi + ' mes' + (numMesi===1?'e':'i') + '</div>'
      + '</div>'
    + '</div>';
  } else {
    box.innerHTML = '<div style="margin-top:16px">'
      + '<div style="font-size:10px;color:#c9a84c;text-transform:uppercase;letter-spacing:1.3px;font-weight:800;margin-bottom:8px">üìä Media mensile per commerciale in base al periodo selezionato</div>'
      + '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">'
      + dfC.map(comm => {
          const col        = commColor(comms, comm);
          const commRows   = filteredNoEx.filter(r => (r.commerciale||'') === comm);
          const commMonths = new Set(commRows.filter(r=>r.dataObj).map(r =>
            r.dataObj.getFullYear()+'-'+String(r.dataObj.getMonth()+1).padStart(2,'0')
          )).size || 1;
          const commMedia  = commRows.reduce((s,r)=>s+r.importo,0) / commMonths;
          return '<div class="kpi-card" style="border-color:' + col.border + '55;background:' + col.bg.replace('0.18','0.08') + '">'
            + '<div class="kpi-label" style="color:' + col.text + ';overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + esc(comm) + '</div>'
            + '<div class="kpi-value" style="color:' + col.text + ';font-size:18px">' + fmtK(commMedia) + '</div>'
            + '<div class="kpi-sub">' + fmtEur(commMedia) + ' ¬∑ ' + commMonths + ' mes' + (commMonths===1?'e':'i') + '</div>'
          + '</div>';
        }).join('')
      + '</div>'
    + '</div>';
  }
}

function afterRender() {
  if (currentTab === 'dashboard') {
    const rows = allRows();
    if (!rows.length) return;

    if (!window._df) window._df = { anni: [], mesi: [], quick: null };
    if (!window._dfComm) window._dfComm = [];
    if (typeof window._dfComm === 'string') window._dfComm = window._dfComm ? [window._dfComm] : [];
    const df      = window._df;
    const dfComm  = window._dfComm;
    const rowsBase = dfComm.length ? rows.filter(r => dfComm.includes(r.commerciale||'')) : rows;

    let filtered;
    if (df.quick) {
      const now  = new Date();
      const startOfCurr = new Date(now.getFullYear(), now.getMonth(), 1);
      const cutoff = new Date(now.getFullYear(), now.getMonth() - parseInt(df.quick), 1);
      filtered = rowsBase.filter(r => r.dataObj && r.dataObj >= cutoff && r.dataObj < startOfCurr);
    } else {
      let byAnno = df.anni.length ? rowsBase.filter(r => r.dataObj && df.anni.includes(r.dataObj.getFullYear())) : rowsBase;
      filtered = df.mesi.length ? byAnno.filter(r => r.dataObj && df.mesi.includes(r.dataObj.getMonth())) : byAnno;
    }

    // Applica esclusioni anche al grafico gi√† al primo render
    const excl = window._excludedClients || [];
    const filteredNoEx = filtered.filter(r => !excl.includes(r.cliente));

    // ‚îÄ‚îÄ Grafico mensile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    _buildMonthlyChart(filteredNoEx, rows, filtered);

    // ‚îÄ‚îÄ Grafico torta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const byClient = {};
    filtered.forEach(r => { byClient[r.cliente] = (byClient[r.cliente]||0) + r.importo; });
    const topClients = Object.entries(byClient).sort((a,b)=>b[1]-a[1]).slice(0,20);

    const pieEl = document.getElementById('chart-pie');
    if (pieEl && topClients.length) {
      const pieClients = topClients.filter(([nome]) => !excl.includes(nome));
      const colors = ['#c9a84c','#4caf82','#5c9ce0','#e05c9c','#9c5ce0','#e07c3a','#3acfe0','#9ce05c','#e0c43a','#7c5ce0',
                      '#5ce0a8','#e05c5c','#5ca8e0','#c45ce0','#e0b45c','#5ce0c4','#e05ca8','#a8e05c','#5c7ce0','#e07c9c'];
      if (chartInstances['pie']) { try { chartInstances['pie'].destroy(); } catch(e){} }
      chartInstances['pie'] = new Chart(pieEl, {
        type: 'doughnut',
        data: {
          labels: pieClients.map(c=>c[0]),
          datasets: [{ data: pieClients.map(c=>c[1]), backgroundColor: colors.slice(0, pieClients.length), borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#7a8099', font: { size: 11 }, boxWidth: 12, padding: 10 } }, tooltip: { callbacks: { label: ctx => ` ${fmtEur(ctx.raw)}` } } }, cutout: '65%' }
      });
    }
  }
}

// ‚îÄ‚îÄ Funzione centrale per costruire/aggiornare il grafico mensile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// filteredRows = righe gi√† filtrate per periodo, commerciale ED esclusioni cliente
// allRows_     = tutte le righe (per calcolo anni disponibili)
// filteredAll  = righe filtrate per periodo/commerciale ma SENZA esclusioni (per mesi disponibili)
function _buildMonthlyChart(filteredRows, allRows_, filteredAll) {
  const mcEl = document.getElementById('chart-monthly');
  if (!mcEl) return;

  const MESI    = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  const df      = window._df || { anni:[], mesi:[], quick:null };
  const dfComm  = window._dfComm || [];
  const anniDisp = [...new Set((allRows_||allRows()).filter(r=>r.dataObj).map(r=>r.dataObj.getFullYear()))].sort((a,b)=>a-b);
  const baseFilt = filteredAll || filteredRows;
  const anniAttivi = df.anni.length ? df.anni
    : (df.quick ? [...new Set(baseFilt.filter(r=>r.dataObj).map(r=>r.dataObj.getFullYear()))].sort()
                : anniDisp);
  const commsDisp   = [...new Set((allRows_||allRows()).map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
  const compareAnni = window._dfCompare && anniAttivi.length >= 2 && !df.quick;
  const compareComm = dfComm.length >= 2;

  // Calcola monthly dai filteredRows (con esclusioni applicate)
  const monthly = {};
  filteredRows.forEach(r => {
    if (!r.dataObj) return;
    const k = r.dataObj.getFullYear() + '-' + String(r.dataObj.getMonth()+1).padStart(2,'0');
    monthly[k] = (monthly[k]||0) + r.importo;
  });
  // Nessun limite: tutti i mesi del periodo selezionato (quick filter gi√† applica il suo range)
  const months      = Object.keys(monthly).sort();
  const monthValues = months.map(k => monthly[k]||0);

  let labels, datasets, showLegend = false, compareActive = false;

  if (compareComm) {
    compareActive = true; showLegend = true;
    // Usa chiavi anno-mese per evitare sovrapposizioni su periodi pluriennali
    const allMonthKeys = [...new Set(
      filteredRows.filter(r => r.dataObj).map(r =>
        r.dataObj.getFullYear() + '-' + String(r.dataObj.getMonth()+1).padStart(2,'0')
      )
    )].sort();
    labels = allMonthKeys.map(k => { const [y,mo] = k.split('-'); return MESI[parseInt(mo)-1]+" '"+y.slice(2); });
    datasets = dfComm.map(comm => {
      const c = commColor(commsDisp, comm);
      const byKey = {};
      filteredRows.filter(r => r.dataObj && (r.commerciale||'') === comm).forEach(r => {
        const k = r.dataObj.getFullYear() + '-' + String(r.dataObj.getMonth()+1).padStart(2,'0');
        byKey[k] = (byKey[k]||0) + r.importo;
      });
      return { label: comm, data: allMonthKeys.map(k => byKey[k]||0),
               backgroundColor: c && c.bg ? c.bg.replace('0.18','0.78') : 'rgba(201,168,76,0.78)',
               borderColor: c && c.border ? c.border : '#c9a84c',
               borderWidth: 1, borderRadius: 4 };
    });

  } else if (compareAnni) {
    compareActive = true; showLegend = true;
    const mesiPresenti = df.mesi.length
      ? df.mesi
      : [...new Set(baseFilt.filter(r=>r.dataObj).map(r=>r.dataObj.getMonth()))].sort((a,b)=>a-b);
    labels = mesiPresenti.map(m => MESI[m]);
    datasets = anniAttivi.map(anno => {
      const c = annoColor(anniDisp, anno);
      const byMese = {};
      filteredRows.filter(r => r.dataObj && r.dataObj.getFullYear() === anno).forEach(r => {
        const mo = r.dataObj.getMonth();
        byMese[mo] = (byMese[mo]||0) + r.importo;
      });
      return { label: String(anno), data: mesiPresenti.map(m => byMese[m]||0),
               backgroundColor: c.bg.replace('0.18','0.78'), borderColor: c.border, borderWidth: 1, borderRadius: 4 };
    });

  } else {
    // Label con anno sempre visibile: "Gen '25", "Feb '25" ...
    labels = months.map(m => { const [y,mo] = m.split('-'); return MESI[parseInt(mo)-1]+" '"+y.slice(2); });

    if (anniAttivi.length > 1 && !df.quick) {
      const bgColors = months.map(mk => annoColor(anniDisp, parseInt(mk.split('-')[0])).bg.replace('0.18','0.75'));
      const bdColors = months.map(mk => annoColor(anniDisp, parseInt(mk.split('-')[0])).border);
      datasets = [{ label: 'Fatturato', data: monthValues, backgroundColor: bgColors, borderColor: bdColors, borderWidth: 1, borderRadius: 5 }];
      showLegend = false;
      window._chartAnniLegend = anniAttivi.map(a => ({ anno: a, color: annoColor(anniDisp, a).border }));
    } else {
      const singleComm = dfComm.length === 1 ? dfComm[0] : null;
      const c = singleComm
        ? commColor(commsDisp, singleComm)
        : (anniAttivi[0] ? annoColor(anniDisp, anniAttivi[0]) : { bg:'rgba(201,168,76,0.75)', border:'#c9a84c' });
      datasets = [{ label: singleComm||'Fatturato', data: monthValues,
                    backgroundColor: c.bg.replace('0.18','0.75'), borderColor: c.border, borderWidth: 1, borderRadius: 5 }];
    }
  }

  if (months.length < 1 && !compareComm && !compareAnni) return;

  // Distruggi il vecchio e ricrea (garantisce label + scale corretti)
  if (chartInstances['monthly']) { try { chartInstances['monthly'].destroy(); } catch(e){} delete chartInstances['monthly']; }


  // Plugin pill solo per asse X
  const pillAxisPlugin = {
    id: 'pillAxis',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const xAxis = chart.scales.x;
      const PILL_H = 18, PILL_PAD = 9, R = 9;
      ctx.save();
      ctx.font = '700 10px DM Sans,sans-serif';
      xAxis.ticks.forEach((tick, i) => {
        const lbl = Array.isArray(tick.label) ? tick.label.join(' ') : tick.label;
        if (!lbl) return;
        const x = xAxis.getPixelForTick(i);
        const y = xAxis.bottom + 4;
        const w = ctx.measureText(lbl).width + PILL_PAD * 2;
        ctx.beginPath();
        ctx.roundRect(x - w/2, y, w, PILL_H, R);
        ctx.fillStyle = 'rgba(255,255,255,0.07)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.18)';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.fillStyle = 'rgba(255,255,255,0.82)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(lbl, x, y + PILL_H / 2);
      });
      ctx.restore();
    }
  };

  chartInstances['monthly'] = new Chart(mcEl, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: { left: 0, bottom: 28 } },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { title: ctx => ctx[0].label, label: ctx => '  ' + ctx.dataset.label + ':  ' + fmtEur(ctx.raw) } }
      },
      scales: {
        x: {
          ticks: {
            color: 'transparent',
            font: { size: 10 },
            maxRotation: 0,
            minRotation: 0,
            maxTicksLimit: months.length <= 24 ? months.length
                         : months.length <= 48  ? Math.ceil(months.length / 2)
                         : months.length <= 72  ? Math.ceil(months.length / 3)
                         : Math.ceil(months.length / 5)
          },
          grid: { display: false }
        },
        y: {
          ticks: {
            color: 'rgba(226,184,74,0.85)',
            font: { size: 10, weight: '700', family: 'DM Sans, sans-serif' },
            callback: v => fmtK(v),
            padding: 6
          },
          grid: { color: 'rgba(255,255,255,0.05)' }
        }
      }
    },
    plugins: [pillAxisPlugin]
  });
}

// ============================================================
// CLIENTI TAB
// ============================================================
let _expandedClient = null;
let _clientSearch = '';
let _clientComm = []; // filtro commerciali nella sezione Clienti

function toggleClient(nomeOrEl) {
  const nome = (typeof nomeOrEl === 'string') ? nomeOrEl : nomeOrEl;
  _expandedClient = _expandedClient === nome ? null : nome;
  _renderClientiList();
}

function _renderClientiList() {
  const el = document.getElementById('clienti-list');
  if (!el) return;
  el.innerHTML = _buildClientiList();
  _updateClientiCommButtons();
  _updateClientiCounter();
}

function _updateClientiCounter() {
  const counter = document.getElementById('clienti-counter');
  if (!counter) return;

  const rows      = allRows();
  const totAll    = new Set(rows.map(r => r.cliente)).size;
  const dfC       = _clientComm || [];
  const q         = (_clientSearch || '').trim().toLowerCase();

  if (!dfC.length && !q) {
    // Nessun filtro attivo ‚Äî mostra solo totale
    counter.style.color = 'var(--text-muted)';
    counter.style.background = 'var(--surface2)';
    counter.style.border = 'none';
    counter.textContent = totAll + ' totali';
    return;
  }

  // Calcola clienti visibili con i filtri attivi
  const byClient = {};
  rows.forEach(r => {
    if (!byClient[r.cliente]) byClient[r.cliente] = { comms: new Set() };
    if (r.commerciale) byClient[r.cliente].comms.add(r.commerciale);
  });

  let filtered = Object.keys(byClient);
  if (dfC.length) {
    filtered = filtered.filter(nome =>
      [...byClient[nome].comms].some(c => dfC.includes(c))
    );
  }
  if (q) {
    filtered = filtered.filter(nome => nome.toLowerCase().includes(q));
  }

  const shown = filtered.length;
  counter.textContent = shown + ' su ' + totAll + ' totali';
  counter.style.color = shown < totAll ? '#e2b84a' : 'var(--text-muted)';
  counter.style.background = shown < totAll ? 'rgba(226,184,74,0.12)' : 'var(--surface2)';
  counter.style.border = shown < totAll ? '1px solid rgba(226,184,74,0.35)' : 'none';
}

function _updateClientiCommButtons() {
  const dfC   = _clientComm || [];
  const comms = [...new Set(allRows().map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
  const wrap  = document.getElementById('clienti-comm-wrap');
  if (!wrap) return;

  // Pulsante "Tutti"
  const tuttiBtn = wrap.querySelector('[data-comm="__tutti__"]');
  if (tuttiBtn) {
    if (!dfC.length) tuttiBtn.classList.add('active');
    else             tuttiBtn.classList.remove('active');
  }

  // Pulsanti commerciali ‚Äî usa data-comm per trovare ciascun btn
  wrap.querySelectorAll('[data-comm]').forEach(btn => {
    const c = btn.getAttribute('data-comm');
    if (c === '__tutti__') return;
    const isActive = dfC.includes(c);
    const col = commColor(comms, c);
    btn.style.background  = isActive ? col.bg.replace('0.18','0.30')  : 'rgba(255,255,255,0.07)';
    btn.style.borderColor = isActive ? col.border                      : col.border + '55';
    btn.style.color       = isActive ? col.text                        : 'rgba(255,255,255,0.6)';
    btn.style.fontWeight  = isActive ? '800'                           : '500';
    btn.style.borderWidth = isActive ? '2px'                           : '1.5px';
    btn.style.boxShadow   = isActive ? '0 0 16px ' + col.border + '88' : 'none';
  });
}

function _buildClientiList() {
  const rows = allRows();
  const byClient = {};
  rows.forEach(r => {
    if (!byClient[r.cliente]) byClient[r.cliente] = { fatture: [], totale: 0, ultima: null };
    byClient[r.cliente].fatture.push(r);
    byClient[r.cliente].totale += r.importo;
    if (!byClient[r.cliente].ultima || (r.dataObj && r.dataObj > byClient[r.cliente].ultima)) byClient[r.cliente].ultima = r.dataObj;
  });

  // Commerciale principale per ogni cliente (il pi√π frequente)
  const commsAll = [...new Set(rows.map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
  const getMainComm = nome => {
    const counts = {};
    (byClient[nome]?.fatture || []).forEach(f => {
      if (f.commerciale && f.commerciale !== '‚Äî') counts[f.commerciale] = (counts[f.commerciale]||0) + 1;
    });
    const entries = Object.entries(counts);
    if (!entries.length) return null;
    return entries.sort((a,b) => b[1]-a[1])[0][0];
  };

  let list = Object.entries(byClient).sort((a,b) => b[1].totale - a[1].totale);

  // Filtra per commerciale selezionato
  if (_clientComm && _clientComm.length) {
    list = list.filter(([nome, d]) =>
      d.fatture.some(f => _clientComm.includes(f.commerciale || ''))
    );
  }

  // Filtra per ricerca incrementale
  const q = (_clientSearch || '').trim().toLowerCase();
  if (q) list = list.filter(([nome]) => nome.toLowerCase().includes(q));

  if (!list.length) return `<div style="text-align:center;padding:40px 20px;color:var(--text-muted);font-size:14px">Nessun cliente trovato per "<strong style="color:var(--text)">${esc(q)}</strong>"</div>`;

  const maxTotale = Object.values(byClient).reduce((m,d) => Math.max(m,d.totale), 0);

  return list.map(([nome,d]) => {
    const isOpen = _expandedClient === nome;
    const grouped = {};
    d.fatture.forEach(f => {
      const key = f.fattura.trim() + '||' + f.data.trim();
      if (!grouped[key]) grouped[key] = { fattura: f.fattura, data: f.data, dataObj: f.dataObj, importo: 0, count: 0 };
      grouped[key].importo += f.importo;
      grouped[key].count++;
    });
    const fattureSorted = Object.values(grouped).sort((a,b) => (b.dataObj||new Date(0)) - (a.dataObj||new Date(0)));

    // Evidenzia il testo cercato nel nome
    let nomeHtml = esc(nome);
    if (q) {
      const idx = nome.toLowerCase().indexOf(q);
      if (idx >= 0) {
        nomeHtml = esc(nome.slice(0,idx)) +
          '<mark style="background:rgba(201,168,76,0.35);color:var(--gold);border-radius:3px;padding:0 2px">' +
          esc(nome.slice(idx, idx+q.length)) + '</mark>' +
          esc(nome.slice(idx+q.length));
      }
    }

    return `
    <div class="card" style="padding:0;margin-bottom:10px;overflow:hidden">
      <div onclick="toggleClient(this.dataset.nome)" data-nome="${esc(nome)}"  style="padding:16px;cursor:pointer;-webkit-tap-highlight-color:transparent">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div style="flex:1;padding-right:12px">
            <div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:3px">
              <span style="font-weight:600;font-size:14px">${nomeHtml}</span>
              ${(() => {
                const comm = getMainComm(nome);
                if (!comm) return '';
                const col = commColor(commsAll, comm);
                return '<span style="display:inline-flex;align-items:center;font-size:10px;font-weight:700;padding:2px 9px;border-radius:20px;background:' + col.bg.replace('0.18','0.25') + ';border:1px solid ' + col.border + '88;color:' + col.text + ';white-space:nowrap">' + esc(comm) + '</span>';
              })()}
            </div>
            <div style="font-size:11px;color:var(--text-muted)">${isOpen ? fattureSorted.length + ' fatt. (raggrupp.)' : d.fatture.length + ' righe'} ‚Ä¢ Ultima: ${d.ultima ? fmtDate(d.ultima) : '‚Äî'}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div class="amount" style="font-size:16px">${fmtEur(d.totale)}</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${((d.totale/maxTotale)*100).toFixed(1)}% del top</div>
          </div>
          <div style="margin-left:10px;color:var(--gold);font-size:16px;line-height:1;align-self:center;transition:transform 0.2s;transform:rotate(${isOpen?'180':'0'}deg)">‚ñæ</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${(d.totale/maxTotale*100).toFixed(1)}%"></div></div>
      </div>
      ${isOpen ? `
      <div style="border-top:1px solid var(--border);background:var(--surface2)">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead>
            <tr style="border-bottom:1px solid var(--border)">
              <th style="padding:8px 12px;color:var(--text-muted);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:0.8px;text-align:left">N¬∞ Fattura</th>
              <th style="padding:8px 12px;color:var(--text-muted);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:0.8px;text-align:left">Data</th>
              <th style="padding:8px 12px;color:var(--text-muted);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:0.8px;text-align:right">Importo</th>
            </tr>
          </thead>
          <tbody>
            ${fattureSorted.map(f => `
              <tr style="border-bottom:1px solid rgba(255,255,255,0.03)">
                <td style="padding:10px 12px"><span class="badge">${esc(f.fattura)}</span></td>
                <td style="padding:10px 12px;color:var(--text-muted)">${fmtDateShort(f.dataObj)}</td>
                <td style="padding:10px 12px;text-align:right" class="amount">${fmtEur(f.importo)}</td>
              </tr>
            `).join('')}
            <tr style="background:rgba(201,168,76,0.05)">
              <td colspan="2" style="padding:10px 12px;font-weight:600;font-size:12px;color:var(--gold)">Totale</td>
              <td style="padding:10px 12px;text-align:right;font-weight:700;color:var(--gold)">${fmtEur(d.totale)}</td>
            </tr>
          </tbody>
        </table>
      </div>
      ` : ''}
    </div>`;
  }).join('');
}

function renderClienti() {
  const rows = allRows();
  if (!rows.length) return emptyState('üë•','Nessun cliente','Importa un file Excel per vedere i clienti');

  const totClienti = new Set(rows.map(r=>r.cliente)).size;
  const q = (_clientSearch||'').trim();

  return `
    <div style="padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:4px;">

      ${(function(){
        const comms = [...new Set(allRows().map(r=>r.commerciale||'').filter(Boolean).filter(c=>c!=='‚Äî'))].sort();
        if (!comms.length) return '';
        const dfC = _clientComm || [];
        return '<div class="filter-group-label" style="margin-bottom:8px;margin-left:-20px;margin-right:-20px">üßë\u200düíº Commerciale</div>'
          + '<div id="clienti-comm-wrap" class="pill-row" style="margin-bottom:10px;align-items:center">'
          + '<button data-comm="__tutti__" class="fpill ' + (!dfC.length ? 'active' : '') + '" onclick="_clientComm=[];_renderClientiList()">Tutti</button>'
          + comms.map(c => {
              const isActive = dfC.includes(c);
              const col = commColor(comms, c);
              const bg   = isActive ? col.bg.replace('0.18','0.30') : 'rgba(255,255,255,0.07)';
              const bord = isActive ? col.border : col.border + 'aa';
              const clr  = isActive ? col.text   : '#ffffffcc';
              const fw   = isActive ? '800' : '500';
              const glow = isActive ? ';box-shadow:0 0 14px ' + col.border + '66' : '';
              const safeC = c.replace(/'/g,"\\'");
              return '<button data-comm="' + safeC + '" class="fpill" style="background:' + bg + ';border-color:' + bord + ';color:' + clr + ';font-weight:' + fw + ';border-width:' + (isActive?'2px':'1.5px') + glow + '" onclick="(function(){if(!_clientComm)_clientComm=[];var i=_clientComm.indexOf(\'' + safeC + '\');if(i>=0)_clientComm.splice(i,1);else _clientComm.push(\'' + safeC + '\');_renderClientiList();})()">\u200b' + esc(c) + '</button>';
            }).join('')
          + '</div>';
      })()}

      <div style="position:relative">
        <svg style="position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:0.4" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input
          type="search"
          id="client-search-input"
          placeholder="Cerca cliente‚Ä¶"
          value="${esc(q)}"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
          style="width:100%;padding:12px 40px 12px 40px;background:var(--surface);border:1px solid var(--border);border-radius:14px;color:var(--text);font-family:DM Sans,sans-serif;font-size:15px;outline:none;-webkit-appearance:none"
          oninput="_clientSearch=this.value;_renderClientiList()"
        >
        ${q ? `<button onclick="_clientSearch='';document.getElementById('client-search-input').value='';_renderClientiList()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:var(--surface2);border:none;color:var(--text-muted);width:24px;height:24px;border-radius:50%;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center">‚úï</button>` : ''}
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 2px 0">
        <span style="font-size:11px;color:#c9a84c;text-transform:uppercase;letter-spacing:1.3px;font-weight:800">Clienti</span>
        <span id="clienti-counter" style="font-size:11px;background:var(--surface2);padding:3px 10px;border-radius:20px;color:var(--text-muted)">${totClienti} totali</span>
      </div>
    </div>
    <div id="clienti-list">${_buildClientiList()}</div>
  `;
}

// ============================================================
// DATI TAB
// ============================================================
function renderDati() {
  return `
    <div class="top-bar">
      <span class="section-label">Dataset importati</span>
      <span class="count-badge">${DB.datasets.length}</span>
    </div>
    ${DB.datasets.length === 0 ? emptyState('üìÅ','Nessun dataset','Importa il tuo primo file Excel') : ''}
    ${DB.datasets.length > 0 ? `
    <div class="card">
      ${DB.datasets.map(ds => `
        <div class="dataset-item">
          <div class="dataset-info">
            <div class="dataset-name">${esc(ds.name)}</div>
            <div class="dataset-meta">${ds.rows.length} righe ‚Ä¢ Caricato ${ds.date}${ds.commerciale && ds.commerciale !== "‚Äî" ? " ‚Ä¢ üßë‚Äçüíº " + esc(ds.commerciale) : ""}</div>
          </div>
          <button class="delete-btn" onclick="deleteDataset('${ds.id}')">‚úï</button>
        </div>
      `).join('')}
    </div>
    <div class="card" style="margin-top:0">
      <div class="card-title">Totale dati</div>
      <div style="display:flex;gap:20px;flex-wrap:wrap">
        <div><div class="kpi-value" style="font-size:18px">${allRows().length}</div><div class="kpi-sub">righe totali</div></div>
        <div><div class="kpi-value" style="font-size:18px">${new Set(allRows().map(r=>r.cliente)).size}</div><div class="kpi-sub">clienti unici</div></div>
        <div><div class="kpi-value" style="font-size:18px">${new Set(allRows().map(r=>r.commerciale||'').filter(Boolean)).size || '‚Äî'}</div><div class="kpi-sub">commerciali</div></div>
      </div>
    </div>
    ` : ''}
    <button class="confirm-btn" onclick="openImportFlow()" style="margin-top:8px">+ Importa nuovo file</button>
  `;
}

// ============================================================
// EXPORT TAB
// ============================================================
function renderSettings() {
  return `
    <div style="padding:0 0 32px">

      <div class="top-bar" style="margin-bottom:16px">
        <span class="section-label">‚öôÔ∏è Impostazioni App</span>
      </div>

      <!-- PERCORSO DI SALVATAGGIO DATI -->
      <div class="settings-section">
        <div class="settings-section-title">üíæ Percorso di salvataggio Dati</div>
        <div id="save-path-section"></div>
      </div>

      <!-- INFO APP -->
      <div class="settings-section">
        <div class="settings-section-title">‚ÑπÔ∏è Informazioni</div>
        <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:48px;height:48px;border-radius:13px;flex-shrink:0;
              background:linear-gradient(135deg,#e2b84a 0%,#c9853a 55%,#a05c20 100%);
              display:flex;align-items:center;justify-content:center;
              box-shadow:0 3px 14px rgba(226,184,74,0.4)">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M3 3h18v4H3z" fill="rgba(255,255,255,0.9)"/>
                <path d="M3 9h11v3H3z" fill="rgba(255,255,255,0.7)"/>
                <path d="M3 14h7v3H3z" fill="rgba(255,255,255,0.5)"/>
                <path d="M17 12l4 4-4 4" stroke="rgba(255,255,255,0.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 16h-6" stroke="rgba(255,255,255,0.95)" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </div>
            <div>
              <div style="font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;
                background:linear-gradient(90deg,#f5d080,#e2b84a,#ff9f2e);
                -webkit-background-clip:text;-webkit-text-fill-color:transparent;
                background-clip:text;line-height:1.2">
                Analisi Fatturato <span style="font-size:12px;letter-spacing:2px;
                  background:linear-gradient(90deg,#fff,#e2b84a);
                  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
                  background-clip:text">PRO</span>
              </div>
              <div id="settings-version" style="font-size:11px;color:var(--text-muted);margin-top:3px">Versione 2.0 ¬∑ build 2026.02.23 - 13:25</div>
            </div>
          </div>
          <div style="width:100%;height:1px;background:rgba(255,255,255,0.06)"></div>
          <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6">
            Ideata e sviluppata da<br>
            <span style="font-size:14px;font-weight:700;color:rgba(255,255,255,0.85)">Andrea Muraro</span>
          </div>
        </div>
        <div class="settings-row" id="pwa-install-row" style="display:none;flex-direction:column;gap:10px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-size:28px">üì≤</div>
            <div>
              <div class="settings-row-label" style="color:#4caf82">Installa su iPhone / iPad</div>
              <div class="settings-row-desc">Aggiungi alla schermata Home per usarla come un'app nativa con dati sempre salvati</div>
            </div>
          </div>
          <div style="background:rgba(76,175,130,0.08);border:1px solid rgba(76,175,130,0.3);border-radius:12px;padding:12px;font-size:12px;color:rgba(255,255,255,0.7);line-height:1.7">
            1. Apri questa pagina in <strong style="color:#fff">Safari</strong><br>
            2. Tocca il pulsante <strong style="color:#fff">Condividi</strong> ‚Üë<br>
            3. Scorri e tocca <strong style="color:#fff">"Aggiungi a schermata Home"</strong><br>
            4. Conferma con <strong style="color:#fff">Aggiungi</strong>
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-row-info">
            <div class="settings-row-label">Dataset in memoria</div>
            <div class="settings-row-desc">${DB.datasets.length} dataset ¬∑ ${allRows().length} righe totali</div>
          </div>
          <span style="font-size:20px;font-weight:700;color:var(--gold)">${DB.datasets.length}</span>
        </div>
      </div>

      <!-- AZIONI -->
      <button class="settings-save-btn" onclick="saveSession()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Salva sessione ora
      </button>

    </div>
  `;
}

function renderExport() {
  const rows = allRows();
  return `
    <div class="card">
      <div class="card-title">Esporta in Excel</div>
      <p style="font-size:13px;color:var(--text-muted);margin:0 0 14px">Scegli il periodo e i commerciali da includere nel file .xlsx</p>
      <button class="export-btn" style="background:linear-gradient(135deg,rgba(33,195,84,0.18),rgba(33,195,84,0.08));border-color:#21c354;color:#21c354;font-weight:700" onclick="openExportExcelModal()">
        <span class="btn-icon">üìä</span> Esporta in Excel (.xlsx)
      </button>
    </div>
    <div class="card">
      <div class="card-title">Esporta in CSV</div>
      <button class="export-btn" onclick="exportCSV()"><span class="btn-icon">üìÑ</span> Esporta tutto in CSV</button>
      <button class="export-btn" onclick="exportCSVFiltered()"><span class="btn-icon">üîç</span> Esporta con filtri attivi</button>
    </div>
    <div class="card">
      <div class="card-title">Esporta per cliente</div>
      ${[...new Set(rows.map(r=>r.cliente))].sort().slice(0,20).map(c => `
        <button class="export-btn" onclick="exportClientCSV('${esc(c)}')" style="padding:10px 14px">
          <span class="btn-icon">üë§</span> ${esc(c)}
        </button>
      `).join('')}
    </div>
  `;
}

function openExportExcelModal() {
  const rows = allRows();
  if (!rows.length) { toast('Nessun dato da esportare', 'error'); return; }

  const datesValid = rows.filter(r => r.dataObj).map(r => r.dataObj);
  const minDate = datesValid.length ? new Date(Math.min(...datesValid)) : new Date();
  const maxDate = datesValid.length ? new Date(Math.max(...datesValid)) : new Date();
  const fmt = d => d.toISOString().slice(0,10);
  const comms = [...new Set(rows.map(r => r.commerciale||'').filter(c => c && c !== '‚Äî'))].sort();
  const COMM_COLORS = ['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#ff922b','#cc5de8','#20c997','#f06595'];

  const inputStyle = "width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:DM Sans,sans-serif;font-size:14px;outline:none;-webkit-appearance:none;box-sizing:border-box";
  const checkStyle = "width:16px;height:16px;accent-color:var(--gold);flex-shrink:0";
  const labelStyle = "display:flex;align-items:flex-start;gap:10px;cursor:pointer;font-size:13px;color:var(--text)";

  document.getElementById('modals').innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-title">üìä Esporta in Excel</div>
        <div class="modal-sub">Configura il file da generare</div>

        <!-- PERIODO -->
        <div class="option-group">
          <div class="option-label">üìÖ Periodo</div>
          <div style="display:flex;gap:10px;align-items:center">
            <div style="flex:1">
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Dal</div>
              <input type="date" id="exp-date-from" value="${fmt(minDate)}" style="${inputStyle}">
            </div>
            <div style="color:var(--text-muted);padding-top:18px">‚Üí</div>
            <div style="flex:1">
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Al</div>
              <input type="date" id="exp-date-to" value="${fmt(maxDate)}" style="${inputStyle}">
            </div>
          </div>
        </div>

        <!-- COMMERCIALI -->
        ${comms.length > 0 ? `
        <div class="option-group">
          <div class="option-label">üßë‚Äçüíº Commerciali <span style="font-weight:400;text-transform:none;font-size:11px;letter-spacing:0;color:var(--text-muted)">(vuoto = tutti)</span></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px">
            ${comms.map((c, idx) => {
              const col = COMM_COLORS[idx % COMM_COLORS.length];
              return `<button onclick="toggleExpComm(this,'${c.replace(/'/g,"\\'")}','${col}')"
                style="padding:7px 14px;border-radius:20px;border:1.5px solid ${col}50;background:transparent;color:${col}80;font-family:DM Sans,sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.18s;-webkit-tap-highlight-color:transparent"
                data-comm="${esc(c)}" data-color="${col}" data-active="false">${esc(c)}</button>`;
            }).join('')}
          </div>
        </div>` : ''}

        <!-- RAGGRUPPAMENTO -->
        <div class="option-group">
          <div class="option-label">üìã Visualizzazione righe</div>
          <div style="display:flex;flex-direction:column;gap:0;border:1px solid var(--border);border-radius:12px;overflow:hidden">

            <label style="${labelStyle};padding:12px 14px;background:var(--surface2);border-bottom:1px solid var(--border)30">
              <input type="radio" id="exp-mode-detail" name="exp-mode" value="detail" checked
                style="width:16px;height:16px;accent-color:var(--gold);margin-top:1px;flex-shrink:0">
              <div>
                <div style="font-weight:600">Dettaglio fatture</div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Una riga per fattura ‚Äî include N¬∞ Fattura e Data</div>
              </div>
            </label>

            <label style="${labelStyle};padding:12px 14px">
              <input type="radio" id="exp-mode-group" name="exp-mode" value="group"
                style="width:16px;height:16px;accent-color:var(--gold);margin-top:1px;flex-shrink:0">
              <div>
                <div style="font-weight:600">Riepilogo per cliente</div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Una riga per cliente ‚Äî somma importi, senza N¬∞ Fattura e Data</div>
              </div>
            </label>

          </div>
        </div>

        <!-- OPZIONI AGGIUNTIVE -->
        <div class="option-group">
          <div class="option-label">‚öôÔ∏è Opzioni</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <label style="${labelStyle}">
              <input type="checkbox" id="exp-totale" checked style="${checkStyle}">
              <div>Aggiungi riga <strong>Totale</strong> in fondo</div>
            </label>
            <label style="${labelStyle}" id="exp-sheet-comm-label">
              <input type="checkbox" id="exp-sheet-per-comm" ${comms.length > 1 ? '' : 'disabled style="opacity:0.35"'} style="${checkStyle}">
              <div>Un foglio separato per ogni commerciale</div>
            </label>
          </div>
        </div>

        <button class="confirm-btn" style="background:linear-gradient(135deg,#21c354,#1aaa45);border:none" onclick="doExportExcel()">üìä Genera Excel</button>
        <button class="cancel-btn" onclick="closeModal()">Annulla</button>
      </div>
    </div>
  `;
  window._expSelectedComms = [];
}

function toggleExpComm(btn, comm, col) {
  if (!window._expSelectedComms) window._expSelectedComms = [];
  const idx = window._expSelectedComms.indexOf(comm);
  if (idx >= 0) {
    window._expSelectedComms.splice(idx, 1);
    btn.style.background = 'transparent';
    btn.style.borderColor = col + '50';
    btn.style.color = col + '80';
    btn.setAttribute('data-active','false');
  } else {
    window._expSelectedComms.push(comm);
    btn.style.background = col + '25';
    btn.style.borderColor = col;
    btn.style.color = col;
    btn.setAttribute('data-active','true');
  }
}

function doExportExcel() {
  const rows = allRows();
  const fromVal  = document.getElementById('exp-date-from').value;
  const toVal    = document.getElementById('exp-date-to').value;
  const addTot   = document.getElementById('exp-totale').checked;
  const byComm   = document.getElementById('exp-sheet-per-comm') && document.getElementById('exp-sheet-per-comm').checked;
  const groupMode = document.querySelector('input[name="exp-mode"]:checked').value === 'group';
  const selComms = (window._expSelectedComms || []);

  const from = fromVal ? new Date(fromVal) : null;
  const to   = toVal   ? new Date(toVal + 'T23:59:59') : null;

  let filtered = rows.filter(r => {
    if (!r.dataObj) return false;
    if (from && r.dataObj < from) return false;
    if (to   && r.dataObj > to)   return false;
    if (selComms.length && !selComms.includes(r.commerciale||'')) return false;
    return true;
  });

  if (!filtered.length) { toast('Nessuna riga corrisponde ai filtri selezionati', 'error'); return; }

  const wb = XLSX.utils.book_new();

  // Helper: formatta data
  const fmtDate = r => r.dataObj
    ? String(r.dataObj.getDate()).padStart(2,'0') + '/' + String(r.dataObj.getMonth()+1).padStart(2,'0') + '/' + r.dataObj.getFullYear()
    : r.data || '';

  // Helper: applica formato numerico alle celle importo
  const applyNumFmt = (ws, colIdx) => {
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let ri = 1; ri <= range.e.r; ri++) {
      const cell = ws[XLSX.utils.encode_cell({ r: ri, c: colIdx })];
      if (cell && typeof cell.v === 'number') { cell.z = '#,##0.00'; cell.t = 'n'; }
    }
  };

  // ‚îÄ‚îÄ Modalit√† DETTAGLIO: una riga per fattura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const buildDetailSheet = (sheetRows, sheetName) => {
    const header = ['Cliente', 'N¬∞ Fattura', 'Data Fattura', 'Importo (‚Ç¨)', 'Commerciale'];
    const data = [header];
    sheetRows.forEach(r => data.push([r.cliente, r.fattura, fmtDate(r), r.importo, r.commerciale||'‚Äî']));
    if (addTot) {
      const tot = sheetRows.reduce((s,r) => s + r.importo, 0);
      data.push(['TOTALE', '', '', tot, '']);
    }
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{wch:32},{wch:16},{wch:14},{wch:16},{wch:20}];
    applyNumFmt(ws, 3);
    XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0,31));
  };

  // ‚îÄ‚îÄ Modalit√† RIEPILOGO: una riga per cliente (importo sommato) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const buildGroupSheet = (sheetRows, sheetName) => {
    // Raggruppa per cliente (+ commerciale se disponibile)
    const map = {};
    sheetRows.forEach(r => {
      const key = r.cliente + '||' + (r.commerciale||'‚Äî');
      if (!map[key]) map[key] = { cliente: r.cliente, commerciale: r.commerciale||'‚Äî', importo: 0, nFatture: 0 };
      map[key].importo += r.importo;
      map[key].nFatture++;
    });
    const grouped = Object.values(map).sort((a,b) => b.importo - a.importo);

    const header = ['Cliente', 'Fatturato (‚Ç¨)', 'Commerciale'];
    const data = [header];
    grouped.forEach(g => data.push([g.cliente, g.importo, g.commerciale]));
    if (addTot) {
      const tot = grouped.reduce((s,g) => s + g.importo, 0);
      data.push(['TOTALE', tot, '']);
    }
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{wch:32},{wch:16},{wch:20}];
    applyNumFmt(ws, 1);
    XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0,31));
  };

  const buildSheet = groupMode ? buildGroupSheet : buildDetailSheet;

  if (byComm) {
    const commsInData = selComms.length
      ? selComms
      : [...new Set(filtered.map(r => r.commerciale||'‚Äî'))].sort();
    commsInData.forEach(c => {
      const sub = filtered.filter(r => (r.commerciale||'‚Äî') === c);
      if (sub.length) buildSheet(sub, c);
    });
    buildSheet(filtered, 'Tutti');
  } else {
    buildSheet(filtered, groupMode ? 'Riepilogo Clienti' : 'Fatture');
  }

  const fmtFn = d => d ? d.toISOString().slice(0,10).replace(/-/g,'') : '';
  const suffix = groupMode ? '_riepilogo' : '_dettaglio';
  const filename = 'vendite' + suffix + '_' + fmtFn(from) + (to ? '_' + fmtFn(to) : '') + '.xlsx';

  XLSX.writeFile(wb, filename);
  closeModal();
  toast('‚úì Excel esportato: ' + filename);
}
// ============================================================
// IMPORT FLOW
// ============================================================
let _pendingFile = null;
let _pendingHeaders = [];
let _pendingData = [];
let _importMode = 'add'; // add | replace
let _colMap = { cliente: '', fattura: '', data: '', importo: '' };
let _commercialeImport = ''; // valore libero digitato o selezionato nel modal

function openImportFlow() {
  document.getElementById('file-input').click();
}

// Struttura fissa attesa:
//   Col A (0) = Nome Cliente
//   Col B (1) = Numero Fattura/Ordine
//   Col C (2) = Data Fattura/Ordine
//   Col F (5) = Importo Fattura/Ordine
const FIXED_COL = { cliente: 0, fattura: 1, data: 2, importo: 5 };

function handleFileSelected(e) {
  const file = e.target.files[0];
  if (!file) return;
  _pendingFile = file;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, { type: 'array', cellDates: true });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, dateNF: 'dd/mm/yyyy' });
    if (json.length < 2) { toast('File vuoto o non valido', 'error'); return; }

    // Salta la riga di intestazione se presente (rileva se riga 0 ha testo nelle colonne attese)
    const firstRow = json[0] || [];
    const hasHeader = isNaN(parseImporto(firstRow[FIXED_COL.importo]));
    _pendingData = hasHeader ? json.slice(1) : json;

    // Anteprima: conta righe valide prima di mostrare il modal
    const validCount = _pendingData.filter(r => {
      const v = r[FIXED_COL.importo];
      return v !== undefined && v !== null && v !== '' && !isNaN(parseImporto(v));
    }).length;

    if (validCount === 0) {
      toast('Nessuna riga valida ‚Äî verifica che il file abbia la struttura corretta (A=Cliente, B=N¬∞Fattura, C=Data, F=Importo)', 'error');
      return;
    }

    showCommercialeModal(file.name, validCount);
  };
  reader.readAsArrayBuffer(file);
}

function autoDetect(headers) {
  const map = { cliente: '', fattura: '', data: '', importo: '' };
  const h = headers.map(h => h.toLowerCase());
  h.forEach((col, i) => {
    if (!map.cliente && (col.includes('cliente') || col.includes('ragione') || col.includes('denominaz'))) map.cliente = headers[i];
    if (!map.fattura && (col.includes('fattura') || col.includes('numero') || col.includes('doc') || col.includes('n.'))) map.fattura = headers[i];
    if (!map.data && (col.includes('data') || col.includes('date'))) map.data = headers[i];
    if (!map.importo && (col.includes('importo') || col.includes('totale') || col.includes('amount') || col.includes('euro') || col.includes('imponib'))) map.importo = headers[i];
    if (!map.commerciale && (col.includes('commerciale') || col.includes('agente') || col.includes('venditore') || col.includes('sales'))) map.commerciale = headers[i];
  });
  return map;
}

function showCommercialeModal(filename, validCount) {
  const prevCommerciali = [...new Set(
    DB.datasets.flatMap(ds => ds.rows.map(r => r.commerciale)).filter(Boolean)
  )].sort();

  document.getElementById('modals').innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-handle"></div>
        <div class="modal-title">Importa Excel</div>

        <div class="modal-sub" style="margin-bottom:14px">
          <strong style="color:var(--text)">${esc(filename)}</strong>
          <span style="display:inline-flex;align-items:center;gap:5px;margin-left:8px;font-size:12px;color:#4caf82;background:rgba(76,175,130,0.12);border:1px solid rgba(76,175,130,0.3);border-radius:20px;padding:2px 10px;font-weight:700">
            ‚úì ${validCount} righe valide
          </span>
        </div>

        <!-- Struttura richiesta per l'importazione -->
        <div style="border:1.5px solid rgba(226,184,74,0.35);border-radius:12px;overflow:hidden;margin-bottom:16px">

          <div style="background:linear-gradient(135deg,rgba(226,184,74,0.22),rgba(226,184,74,0.10));padding:10px 14px;border-bottom:1px solid rgba(226,184,74,0.25);display:flex;align-items:center;gap:8px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#e2b84a" stroke-width="2.5" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="13" y2="17"/></svg>
            <span style="font-size:10px;font-weight:900;color:#e2b84a;text-transform:uppercase;letter-spacing:1.2px">Struttura richiesta per l'importazione del file</span>
          </div>

          <div style="background:#1a1e2a;overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;font-family:monospace;font-size:11px;min-width:340px">
              <thead>
                <tr style="background:rgba(255,255,255,0.05)">
                  <th style="width:26px;padding:5px 0;text-align:center;color:rgba(255,255,255,0.2);font-weight:500;border-right:1px solid rgba(255,255,255,0.07);font-size:9px"> </th>
                  ${['A','B','C','D','E','F'].map(c => {
                    const active = ['A','B','C','F'].includes(c);
                    return '<th style="padding:5px 4px;text-align:center;color:' + (active?'#e2b84a':'rgba(255,255,255,0.2)') + ';font-weight:' + (active?'900':'400') + ';border-right:1px solid rgba(255,255,255,0.07);background:' + (active?'rgba(226,184,74,0.1)':'') + ';font-size:11px">' + c + '</th>';
                  }).join('')}
                </tr>
              </thead>
              <tbody>
                ${[
                  ['ROSSI SRL','FT-001','15/01/2025','','','1.250,00'],
                  ['BIANCHI SPA','FT-002','22/01/2025','','','890,50'],
                  ['VERDE & CO.','FT-003','30/01/2025','','','3.400,00'],
                ].map((row, ri) =>
                  '<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">'
                  + '<td style="padding:5px 0;text-align:center;color:rgba(255,255,255,0.18);font-size:9px;border-right:1px solid rgba(255,255,255,0.07)">' + (ri+1) + '</td>'
                  + '<td style="padding:5px 7px;color:rgba(255,255,255,0.72);border-right:1px solid rgba(255,255,255,0.07);background:rgba(226,184,74,0.03);font-size:10px">' + row[0] + '</td>'
                  + '<td style="padding:5px 7px;color:rgba(255,255,255,0.55);border-right:1px solid rgba(255,255,255,0.07);background:rgba(226,184,74,0.03);font-size:10px">' + row[1] + '</td>'
                  + '<td style="padding:5px 7px;color:rgba(255,255,255,0.55);border-right:1px solid rgba(255,255,255,0.07);background:rgba(226,184,74,0.03);font-size:10px">' + row[2] + '</td>'
                  + '<td style="padding:5px 7px;color:rgba(255,255,255,0.12);border-right:1px solid rgba(255,255,255,0.07);font-size:10px;text-align:center">¬∑</td>'
                  + '<td style="padding:5px 7px;color:rgba(255,255,255,0.12);border-right:1px solid rgba(255,255,255,0.07);font-size:10px;text-align:center">¬∑</td>'
                  + '<td style="padding:5px 7px;color:#4cdf8a;border-right:1px solid rgba(255,255,255,0.07);background:rgba(226,184,74,0.03);font-size:10px;font-weight:700">' + row[5] + '</td>'
                  + '</tr>'
                ).join('')}
              </tbody>
            </table>
          </div>

          <div style="padding:9px 14px;background:rgba(0,0,0,0.3);border-top:1px solid rgba(255,255,255,0.06);display:flex;flex-wrap:wrap;gap:6px 12px;align-items:center">
            ${[['A','Nome Cliente'],['B','N¬∞ Fattura/Ordine'],['C','Data'],['F','Importo ‚Ç¨']].map(([col,desc]) =>
              '<span style="display:inline-flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.5)">'
              + '<span style="font-family:monospace;font-weight:900;font-size:10px;color:#e2b84a;background:rgba(226,184,74,0.15);border:1px solid rgba(226,184,74,0.4);border-radius:3px;padding:0 5px;line-height:16px">' + col + '</span>'
              + desc + '</span>'
            ).join('')}
            <span style="font-size:10px;color:rgba(255,255,255,0.25);border-left:1px solid rgba(255,255,255,0.1);padding-left:10px">D ¬∑ E ignorati</span>
          </div>

          <!-- NOTA RIGA 1 -->
          <div style="display:flex;align-items:flex-start;gap:10px;padding:11px 14px;background:linear-gradient(135deg,rgba(255,71,87,0.18),rgba(255,71,87,0.10));border-top:2px solid rgba(255,71,87,0.6)">
            <span style="font-size:18px;flex-shrink:0;line-height:1">‚ö†Ô∏è</span>
            <div>
              <div style="font-size:11px;font-weight:900;color:#ff4757;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:3px">‚ö†Ô∏è Niente titoli ‚Äî i dati iniziano dalla riga 1</div>
              <div style="font-size:11px;color:rgba(255,255,255,0.75);line-height:1.5">Come vedi nell&#39;esempio, <strong style="color:#fff">la riga 1 contiene gi√† il primo cliente.</strong> Il file non deve avere alcuna riga di intestazione: niente "Nome Cliente", "Data", ecc. ‚Äî solo dati, fin dalla prima riga.</div>
            </div>
          </div>
        </div>

        <!-- Modalit√† -->
        <div class="option-group">
          <div class="option-label">Modalit√† importazione</div>
          <div class="options">
            <button class="opt-btn ${_importMode==='add'?'selected':''}" onclick="window._importMode='add';this.parentElement.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));this.classList.add('selected')">‚ûï Aggiungi</button>
            <button class="opt-btn ${_importMode==='replace'?'selected':''}" onclick="window._importMode='replace';this.parentElement.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));this.classList.add('selected')">üîÑ Sostituisci tutto</button>
          </div>
        </div>

        <!-- Commerciale -->
        <div class="option-group">
          <div class="option-label" style="display:flex;align-items:center;gap:6px">
            <span>üßë‚Äçüíº Commerciale di riferimento</span>
          </div>
          <input
            type="text"
            id="commerciale-input"
            placeholder="Nome commerciale‚Ä¶"
            value="${esc(_commercialeImport)}"
            autocomplete="off"
            list="commerciali-list"
            oninput="window._commercialeImport=this.value"
            style="width:100%;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:DM Sans,sans-serif;font-size:14px;outline:none;-webkit-appearance:none;box-sizing:border-box"
          >
          <datalist id="commerciali-list">
            ${prevCommerciali.map(c => `<option value="${esc(c)}">`).join('')}
          </datalist>
          ${prevCommerciali.length > 0 ? `
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
            ${prevCommerciali.map(c => `
              <button onclick="document.getElementById('commerciale-input').value='${esc(c)}';window._commercialeImport='${esc(c)}'"
                style="padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);font-family:DM Sans,sans-serif;font-size:12px;cursor:pointer">
                ${esc(c)}
              </button>
            `).join('')}
          </div>` : ''}
        </div>

        <button class="confirm-btn" onclick="confirmImport()">‚úì Importa dati</button>
        <button class="cancel-btn" onclick="closeModal()">Annulla</button>
      </div>
    </div>
  `;
  window._importMode = _importMode;
  window._commercialeImport = _commercialeImport;
}

function closeModal() {
  document.getElementById('modals').innerHTML = '';
}

function _dupKey(r) {
  // Chiave univoca: cliente + numero fattura + data + importo (arrotondato a 2 dec)
  return [
    r.cliente.toLowerCase().trim(),
    r.fattura.toLowerCase().trim(),
    r.data.trim(),
    parseFloat(r.importo).toFixed(2)
  ].join('||');
}

function confirmImport() {
  const mode = window._importMode || _importMode;

  // Indici fissi: A=0, B=1, C=2, F=5
  const ci = FIXED_COL.cliente;
  const fi = FIXED_COL.fattura;
  const di = FIXED_COL.data;
  const ii = FIXED_COL.importo;

  // Costruisce set delle chiavi gi√† presenti nel DB (solo in modalit√† aggiungi)
  const existingKeys = new Set();
  if (mode !== 'replace') {
    allRows().forEach(r => existingKeys.add(_dupKey(r)));
  }

  const rows = [];
  let skipped = 0;

  _pendingData.forEach(row => {
    const raw = row[ii];
    if (raw === undefined || raw === null || raw === '') return;
    const importo = parseImporto(raw);
    if (isNaN(importo) || importo === null) return;
    const dataRaw = di >= 0 ? String(row[di]||'') : '';
    const dataObj = parseDate(dataRaw);
    const newRow = {
      cliente: String(row[ci]||'‚Äî').trim(),
      fattura: fi >= 0 ? String(row[fi]||'‚Äî').trim() : '‚Äî',
      data: dataRaw,
      dataObj: dataObj,
      importo: importo,
      commerciale: (window._commercialeImport || '').trim() || '‚Äî'
    };
    // Controlla duplicato
    const key = _dupKey(newRow);
    if (existingKeys.has(key)) {
      skipped++;
      return;
    }
    // Aggiunge la chiave per evitare duplicati anche all'interno del file stesso
    existingKeys.add(key);
    rows.push(newRow);
  });

  if (!rows.length && skipped > 0) {
    toast('Tutte le ' + skipped + ' righe erano gi√† presenti ‚Äî nessuna importata', 'error');
    return;
  }
  if (!rows.length) { toast('Nessuna riga valida trovata','error'); return; }

  const ds = {
    id: Date.now().toString(),
    name: _pendingFile.name,
    date: new Date().toLocaleDateString('it-IT'),
    commerciale: (window._commercialeImport || '').trim() || '‚Äî',
    rows
  };

  if (mode === 'replace') DB.datasets = [ds];
  else DB.datasets.push(ds);

  save();
  closeModal();

  // Messaggio dettagliato
  if (skipped > 0) {
    toast('‚úì Importate ' + rows.length + ' righe ¬∑ ' + skipped + ' gi√† presenti e saltate');
  } else {
    toast('‚úì Importate ' + rows.length + ' righe');
  }
  if (SETTINGS.autoSave) {
    saveSession();
  } else {
    markUnsaved();
  }
  showTab('dashboard');
}

function deleteDataset(id) {
  if (!confirm('Eliminare questo dataset?')) return;
  DB.datasets = DB.datasets.filter(d => d.id !== id);
  save();
  render();
  markUnsaved();
  toast('Dataset eliminato');
}

// ============================================================
// EXPORT
// ============================================================
function rowsToCSV(rows) {
  const header = 'Cliente,N¬∞ Fattura,Data,Importo\n';
  const body = rows.map(r => `"${r.cliente}","${r.fattura}","${r.data}",${r.importo}`).join('\n');
  return header + body;
}

function downloadCSV(csv, name) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

function exportCSV() {
  const rows = allRows();
  if (!rows.length) { toast('Nessun dato da esportare','error'); return; }
  downloadCSV(rowsToCSV(rows), 'vendite_export.csv');
  toast('Export avviato');
}

function exportCSVFiltered() {
  let rows = allRows();
  if (_fattureSearch) rows = rows.filter(r => r.cliente.toLowerCase().includes(_fattureSearch.toLowerCase()));
  if (_fattureClient) rows = rows.filter(r => r.cliente === _fattureClient);
  downloadCSV(rowsToCSV(rows), 'vendite_filtrate.csv');
  toast('Export avviato');
}

function exportClientCSV(cliente) {
  const rows = allRows().filter(r => r.cliente === cliente);
  downloadCSV(rowsToCSV(rows), `vendite_${cliente.replace(/\s+/g,'_')}.csv`);
  toast('Export avviato');
}

// ============================================================
// UTILS
// ============================================================
function parseImporto(raw) {
  if (typeof raw === 'number') return raw;
  let s = String(raw).trim();
  s = s.replace(/‚Ç¨/g, '').replace(/¬†/g, '').replace(/\s/g, '').trim();
  if (!s) return null;
  const negative = s.startsWith('-');
  s = s.replace(/^[+\-]/, '');
  let result;
  const lastDot   = s.lastIndexOf('.');
  const lastComma = s.lastIndexOf(',');
  if (lastComma !== -1 && lastDot !== -1) {
    if (lastComma > lastDot) {
      s = s.replace(/\./g, '').replace(',', '.');
    } else {
      s = s.replace(/,/g, '');
    }
    result = parseFloat(s);
  } else if (lastComma !== -1) {
    const parts = s.split(',');
    if (parts.length === 2 && parts[1].length <= 2) {
      result = parseFloat(s.replace(',', '.'));
    } else {
      result = parseFloat(s.replace(/,/g, ''));
    }
  } else if (lastDot !== -1) {
    const parts = s.split('.');
    if (parts.length === 2 && parts[1].length <= 2) {
      result = parseFloat(s);
    } else {
      result = parseFloat(s.replace(/\./g, ''));
    }
  } else {
    result = parseFloat(s);
  }
  if (isNaN(result)) return null;
  return negative ? -result : result;
}

function fmtEur(v) {
  // Formattazione manuale garantita per Safari iOS: 8.870,62 ‚Ç¨
  const neg = v < 0;
  const abs = Math.abs(v);
  const parts = abs.toFixed(2).split('.');
  // Aggiunge il punto ogni 3 cifre nella parte intera
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  // Sostituisce il punto decimale con la virgola
  return (neg ? '-' : '') + parts[0] + ',' + parts[1] + ' ‚Ç¨';
}
function fmtK(v) {
  if (v >= 1000000) return fmtEur(v/1000000).replace(' ‚Ç¨','') + 'M ‚Ç¨';
  return fmtEur(v);
}
function fmtDateShort(d) {
  // Formato sempre gg/mm/aaaa, funziona su tutti i browser incluso Safari iOS
  if (!d) return '‚Äî';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return dd + '/' + mm + '/' + yyyy;
}
function fmtDate(d) {
  return fmtDateShort(d);
}
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function parseDate(s) {
  if (!s) return null;
  // try ISO
  let d = new Date(s);
  if (!isNaN(d)) return d;
  // try dd/mm/yyyy
  const m = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if (m) {
    const [,dd,mm,yyyy] = m;
    d = new Date(`${yyyy.length===2?'20'+yyyy:yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`);
    if (!isNaN(d)) return d;
  }
  return null;
}
function emptyState(icon, title, text) {
  return `<div class="empty"><div class="empty-icon">${icon}</div><h3>${title}</h3><p>${text}</p><button class="confirm-btn" style="margin-top:24px;max-width:280px" onclick="openImportFlow()">Importa file Excel</button></div>`;
}
function toast(msg, type='success', duration=3100) {
  const t = document.createElement('div');
  t.className = 'toast' + (type==='error'?' error':type==='ok'?' ok':'');
  t.textContent = msg;
  // Per durate lunghe: disabilita l'animazione di uscita a 2.7s
  if (duration > 3500) {
    t.style.animation = 'toastIn 0.3s forwards';
    setTimeout(() => {
      t.style.animation = 'toastOut 0.5s forwards';
      setTimeout(() => t.remove(), 500);
    }, duration - 500);
  }
  document.body.appendChild(t);
  if (duration <= 3500) setTimeout(() => t.remove(), duration);
}

// ============================================================
// INIT
// ============================================================
window._fattureSearch = _fattureSearch;
window._fattureClient = _fattureClient;
window._fattureCommerciale = _fattureCommerciale;
window._fatturePeriod = _fatturePeriod;
window._importMode = _importMode;
window._colMap = _colMap;
window._commercialeImport = _commercialeImport;

const APP_VERSION = '20260223-132528';

loadFromIDB(); // carica da localStorage e mostra i dati
renderSavePathSection();
_renderStorageStatusBar();

// ‚îÄ‚îÄ Auto-load unificato all'avvio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// localStorage: gi√† caricato da loadFromIDB() ‚Äî il toast √® gestito l√¨.
// Se DB ancora vuoto e metodo configurato, suggerisci Carica Dati.
(function autoLoadCloud() {
  if (DB.datasets.length > 0) return; // gi√† caricato da localStorage ‚úì
  const method = SETTINGS.saveMethod;
  if (method && method !== '') {
    setTimeout(() => {
      toast('\ud83d\udce2 Nessun dato in memoria ‚Äî usa Carica Dati per ripristinare il database');
    }, 1000);
  }
})();

// Banner avviso percorso salvataggio non configurato
(function checkSaveMethod() {
  if (SETTINGS.saveMethod) return; // gi√† configurato
  setTimeout(() => {
    const el = document.createElement('div');
    el.id = 'banner-no-save';
    el.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(90deg,#1a0a00,#2a1500);border-bottom:2px solid #ff4757;padding:10px 16px;display:flex;align-items:center;gap:10px;font-family:"DM Sans",sans-serif';
    el.innerHTML = '<span style="font-size:18px">‚ö†Ô∏è</span><span style="flex:1;font-size:13px;color:#fff;font-weight:600">Percorso di salvataggio non configurato ‚Äî i dati potrebbero andare persi</span><button onclick="document.getElementById(\'banner-no-save\').remove();showTab(\'settings\')" style="padding:7px 14px;border-radius:10px;background:#ff4757;border:none;color:#fff;font-weight:700;font-size:12px;cursor:pointer;font-family:sans-serif">Configura ora</button><button onclick="document.getElementById(\'banner-no-save\').remove()" style="padding:7px 14px;border-radius:10px;background:rgba(255,255,255,0.1);border:none;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;font-family:sans-serif">‚úï</button>';
    document.body.prepend(el);
  }, 1200);
})();

// Popola badge versione nell'header
(function() {
  const el = document.getElementById('header-version');
  const v = APP_VERSION; // formato: YYYYMMDD-HHMMSS
  const parts = v.split('-');
  let verLabel = 'v ' + v;
  if (parts.length === 2) {
    const d = parts[0];
    const t = parts[1];
    const data = d.slice(0,4) + '.' + d.slice(4,6) + '.' + d.slice(6,8);
    const ora  = t.slice(0,2) + ':' + t.slice(2,4);
    verLabel = 'v ' + data + ' - ' + ora;
  }
  if (el) el.textContent = verLabel;
  // Aggiorna anche il label nella sezione Impostazioni
  const sv = document.getElementById('settings-version');
  if (sv) sv.textContent = 'Versione 2.0 ¬∑ build ' + verLabel;
})();

// Mostra banner installazione iOS se non gi√† installata
(function checkPWA() {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isInstalled = window.navigator.standalone === true;
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isIOS && !isInstalled) {
    const el = document.getElementById('pwa-install-row');
    if (el) el.style.display = 'flex';
  }
})();

// ‚îÄ‚îÄ Dialogo di chiusura ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCloseDialog() {
  // Rimuovi eventuale overlay esistente
  const existing = document.getElementById('close-overlay');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.id = 'close-overlay';
  el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.82);backdrop-filter:blur(8px);z-index:99999;display:flex;align-items:flex-end;justify-content:center;animation:fadeInOverlay 0.2s ease';
  el.innerHTML = `
    <div style="background:#1a1f2a;border:2px solid rgba(226,184,74,0.4);border-radius:20px 20px 0 0;padding:28px 24px 40px;width:100%;max-width:480px;animation:slideUpSheet 0.25s cubic-bezier(.2,.9,.4,1)">
      <div style="font-size:40px;text-align:center;margin-bottom:14px">üíæ</div>
      <div style="font-size:18px;font-weight:800;color:#fff;text-align:center;margin-bottom:8px">Vuoi salvare prima di uscire?</div>
      <div style="font-size:13px;color:rgba(255,255,255,0.5);text-align:center;margin-bottom:24px;line-height:1.5">
        I dati vengono mantenuti automaticamente nell'App.<br>
        Puoi anche scaricare una copia di backup (.json).
      </div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="close-save-json" style="width:100%;padding:14px;border-radius:14px;font-family:sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#4caf82,#3a9e72);border:2px solid #4caf82;color:#fff;box-shadow:0 4px 18px rgba(76,175,130,0.4)">
          üíæ Salva File (.json) ed esci
        </button>
        <button id="close-just-exit" style="width:100%;padding:14px;border-radius:14px;font-family:sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:rgba(226,184,74,0.12);border:2px solid rgba(226,184,74,0.45);color:#e2b84a">
          ‚úì Esci (dati salvati nell'App)
        </button>
        <button id="close-cancel" style="width:100%;padding:14px;border-radius:14px;font-family:sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.18);color:rgba(255,255,255,0.6)">
          ‚úï Annulla
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(el);

  document.getElementById('close-save-json').onclick = () => {
    saveSession(); // scarica .json
    save();        // salva su IDB
    markSaved();
    el.remove();
  };
  document.getElementById('close-just-exit').onclick = () => {
    save();        // salva su IDB prima di uscire
    markSaved();
    el.remove();
    toast('\u2713 Dati salvati nell\u0027App');
  };
  document.getElementById('close-cancel').onclick = () => el.remove();
}

// Intercetta chiusura scheda/finestra
window.addEventListener('beforeunload', function(e) {
  save(); // salva su localStorage prima di chiudere
  // Se ci sono modifiche non salvate su .json, mostra avviso nativo
  if (_unsavedChanges && DB.datasets.length > 0) {
    e.preventDefault();
    e.returnValue = 'Dati salvati. Vuoi anche scaricare il file .json di backup?';
    return e.returnValue;
  }
});

// Su PWA / visibilitychange: salva quando l&#39;app va in background
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'hidden' && DB.datasets.length > 0) {
    save();
    console.log('[AFP] Auto-salvataggio in background');
  }
});

</script>
</body>
</html>
